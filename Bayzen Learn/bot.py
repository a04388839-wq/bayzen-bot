import logging
import sqlite3
import secrets
import string
import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup, InputMediaPhoto
from telegram.ext import (
    Application, CommandHandler, MessageHandler,
    CallbackQueryHandler, ContextTypes, filters
)

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# –¢–æ–∫–µ–Ω –±–æ—Ç–∞ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
BOT_TOKEN = os.getenv('BOT_TOKEN', '8430319931:AAFrOPwJWGRIODbz-EApnbpANlphXHi1Wxk')
ADMIN_USERNAME = os.getenv('ADMIN_USERNAME', 'Prd_ars')

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è —Ç–æ–∫–µ–Ω–∞
if not BOT_TOKEN or BOT_TOKEN == '':
    logger.error("BOT_TOKEN –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω! –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è BOT_TOKEN")
    raise ValueError("BOT_TOKEN –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞")

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
def init_db():
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    # –¢–∞–±–ª–∏—Ü–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS admins (
            username TEXT PRIMARY KEY
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –∫–æ–¥–æ–≤ –¥–æ—Å—Ç—É–ø–∞
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS access_codes (
            code TEXT PRIMARY KEY,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            used_by INTEGER,
            used_at TIMESTAMP,
            is_used INTEGER DEFAULT 0
        )
    ''')
    
    # –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            user_id INTEGER PRIMARY KEY,
            username TEXT,
            state TEXT DEFAULT 'waiting_code',
            current_page INTEGER DEFAULT 0,
            has_access INTEGER DEFAULT 0,
            lesson_completed INTEGER DEFAULT 0,
            last_bot_message_id INTEGER,
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            last_activity TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–ª–æ–Ω–∫–∏ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    try:
        cursor.execute('ALTER TABLE users ADD COLUMN last_bot_message_id INTEGER')
    except sqlite3.OperationalError:
        pass
    
    # –¢–∞–±–ª–∏—Ü–∞ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS registration_applications (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id INTEGER NOT NULL,
            username TEXT,
            id_front_file_id TEXT,
            id_back_file_id TEXT,
            address_document_file_id TEXT,
            passport_photo_file_id TEXT,
            location_photo_file_id TEXT,
            bank_info TEXT,
            status TEXT DEFAULT 'pending',
            created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (user_id) REFERENCES users(user_id)
        )
    ''')
    
    # –î–æ–±–∞–≤–ª—è–µ–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
    cursor.execute('INSERT OR IGNORE INTO admins (username) VALUES (?)', (ADMIN_USERNAME,))
    
    conn.commit()
    conn.close()

# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω–æ–≥–æ –∫–æ–¥–∞
def generate_unique_code():
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    while True:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∫–æ–¥ –∏–∑ 8 —Å–∏–º–≤–æ–ª–æ–≤
        code = ''.join(secrets.choice(string.ascii_uppercase + string.digits) for _ in range(8))
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
        cursor.execute('SELECT code FROM access_codes WHERE code = ?', (code,))
        if not cursor.fetchone():
            cursor.execute('INSERT INTO access_codes (code) VALUES (?)', (code,))
            conn.commit()
            conn.close()
            return code
    
    conn.close()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
def is_admin(username):
    if not username:
        return False
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT username FROM admins WHERE username = ?', (username,))
    result = cursor.fetchone()
    conn.close()
    return result is not None

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def get_user_state(user_id):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT state, current_page, has_access, lesson_completed, last_bot_message_id FROM users WHERE user_id = ?', (user_id,))
    result = cursor.fetchone()
    conn.close()
    if result:
        return {
            'state': result[0],
            'current_page': result[1],
            'has_access': result[2],
            'lesson_completed': result[3],
            'last_bot_message_id': result[4] if len(result) > 4 else None
        }
    return None

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ message_id –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –±–æ—Ç–∞
def save_bot_message_id(user_id, message_id):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE users SET last_bot_message_id = ? WHERE user_id = ?', (message_id, user_id))
    conn.commit()
    conn.close()

# –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def save_user_state(user_id, username, state=None, current_page=None, has_access=None, lesson_completed=None):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    cursor.execute('SELECT user_id FROM users WHERE user_id = ?', (user_id,))
    exists = cursor.fetchone()
    
    if exists:
        updates = []
        params = []
        
        if state is not None:
            updates.append('state = ?')
            params.append(state)
        if current_page is not None:
            updates.append('current_page = ?')
            params.append(current_page)
        if has_access is not None:
            updates.append('has_access = ?')
            params.append(has_access)
        if lesson_completed is not None:
            updates.append('lesson_completed = ?')
            params.append(lesson_completed)
        
        updates.append('last_activity = CURRENT_TIMESTAMP')
        params.append(user_id)
        
        query = f"UPDATE users SET {', '.join(updates)} WHERE user_id = ?"
        cursor.execute(query, params)
    else:
        cursor.execute('''
            INSERT INTO users (user_id, username, state, current_page, has_access, lesson_completed)
            VALUES (?, ?, ?, ?, ?, ?)
        ''', (user_id, username, state or 'waiting_code', current_page or 0, has_access or 0, lesson_completed or 0))
    
    conn.commit()
    conn.close()

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞
def use_code(code, user_id):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    cursor.execute('SELECT is_used FROM access_codes WHERE code = ?', (code.upper(),))
    result = cursor.fetchone()
    
    if not result:
        conn.close()
        return False, "–ö–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω"
    
    if result[0] == 1:
        conn.close()
        return False, "–ö–æ–¥ —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω"
    
    # –ü–æ–º–µ—á–∞–µ–º –∫–æ–¥ –∫–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–π
    cursor.execute('''
        UPDATE access_codes 
        SET is_used = 1, used_by = ?, used_at = CURRENT_TIMESTAMP 
        WHERE code = ?
    ''', (user_id, code.upper()))
    
    conn.commit()
    conn.close()
    return True, "–ö–æ–¥ —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω"

# –£–¥–∞–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
def revoke_user_access(user_id):
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('''
        UPDATE users 
        SET has_access = 0, state = 'waiting_code', current_page = 0, lesson_completed = 0
        WHERE user_id = ?
    ''', (user_id,))
    conn.commit()
    conn.close()

# –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∑–∞—è–≤–∫–∞–º–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
def create_registration_application(user_id, username):
    """–°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞—è–≤–∫–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
    cursor.execute('SELECT id FROM registration_applications WHERE user_id = ? AND status = "pending"', (user_id,))
    existing = cursor.fetchone()
    
    if existing:
        conn.close()
        return existing[0]
    
    cursor.execute('''
        INSERT INTO registration_applications (user_id, username, status)
        VALUES (?, ?, 'pending')
    ''', (user_id, username))
    
    application_id = cursor.lastrowid
    conn.commit()
    conn.close()
    return application_id

def update_registration_application(user_id, field, value):
    """–û–±–Ω–æ–≤–ª—è–µ—Ç –ø–æ–ª–µ –≤ –∑–∞—è–≤–∫–µ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute(f'UPDATE registration_applications SET {field} = ? WHERE user_id = ? AND status = "pending"', (value, user_id))
    conn.commit()
    conn.close()

def get_registration_application(user_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM registration_applications WHERE user_id = ? AND status = "pending"', (user_id,))
    result = cursor.fetchone()
    conn.close()
    return result

def complete_registration(user_id):
    """–ó–∞–≤–µ—Ä—à–∞–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é - –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –Ω–∞ completed"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('UPDATE registration_applications SET status = "completed" WHERE user_id = ? AND status = "pending"', (user_id,))
    conn.commit()
    conn.close()

def delete_registration_application(application_id):
    """–£–¥–∞–ª—è–µ—Ç –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('DELETE FROM registration_applications WHERE id = ?', (application_id,))
    conn.commit()
    conn.close()

def delete_user_registration_data(user_id):
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('DELETE FROM registration_applications WHERE user_id = ?', (user_id,))
    conn.commit()
    conn.close()

def get_all_registration_applications():
    """–ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT id, user_id, username, created_at FROM registration_applications WHERE status = "completed" ORDER BY created_at DESC')
    results = cursor.fetchall()
    conn.close()
    return results

def get_registration_application_index(application_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –∏–Ω–¥–µ–∫—Å –∑–∞—è–≤–∫–∏ –≤ —Å–ø–∏—Å–∫–µ –∏ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫"""
    applications = get_all_registration_applications()
    for index, app in enumerate(applications):
        if app[0] == application_id:
            return index, len(applications)
    return None, len(applications)

def get_registration_application_by_id(application_id):
    """–ü–æ–ª—É—á–∞–µ—Ç –∑–∞—è–≤–∫—É –ø–æ ID"""
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    cursor.execute('SELECT * FROM registration_applications WHERE id = ?', (application_id,))
    result = cursor.fetchone()
    conn.close()
    return result


# –¢–µ–∫—Å—Ç—ã –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–∫–∞ (—Ä–∞–∑–¥–µ–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã)
LESSON_1_PAGES = [
    """üéØ <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –∫—Ä–∏–ø—Ç–æ–ø—Ä–æ–µ–∫—Ç Bayzen!</b>

–≠—Ç–æ —É–Ω–∏–∫–∞–ª—å–Ω–∞—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–ª—è –∑–∞—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π —Å –≤–∞—à–µ–π —Å—Ç–æ—Ä–æ–Ω—ã.

<b>–ß—Ç–æ –æ—Ç –≤–∞—Å —Ç—Ä–µ–±—É–µ—Ç—Å—è:</b>
‚Ä¢ –í–∞–º –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞
‚Ä¢ –í–∞—à–∞ –∑–∞–¥–∞—á–∞ - –Ω–∞–∫–∞–ø–ª–∏–≤–∞—Ç—å —ç—Ç–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞
‚Ä¢ –ö–æ–≥–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–∞—Å—Ç –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤—ã–≤–æ–¥ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç—ã, –≤—ã –ø–µ—Ä–µ–≤–æ–¥–∏—Ç–µ —É–∫–∞–∑–∞–Ω–Ω—É—é —Å—É–º–º—É –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –∞–¥—Ä–µ—Å""",
    
    """üí∞ <b>–°–∏—Å—Ç–µ–º–∞ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–π:</b>

–ó–∞ –∫–∞–∂–¥—ã–µ <b>$150</b>, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç–µ, –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <b>$3</b> –≤ –∫–∞—á–µ—Å—Ç–≤–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è.

<b>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –∑–∞—Ä–∞–±–æ—Ç–∫–∞:</b>
‚Ä¢ –í–∞—à –¥–æ—Ö–æ–¥ –Ω–∞–ø—Ä—è–º—É—é –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤–∞—à–µ–π –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
‚Ä¢ –ß–µ–º –±–æ–ª—å—à–µ –æ–ø–µ—Ä–∞—Ü–∏–π –≤—ã –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ, —Ç–µ–º –≤—ã—à–µ –≤–∞—à –∑–∞—Ä–∞–±–æ—Ç–æ–∫
‚Ä¢ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
‚Ä¢ –í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ –∏ –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫""",
    
    """üìà <b>–ö–∞—Ä—å–µ—Ä–Ω—ã–π —Ä–æ—Å—Ç –∏ —Ä–∞–∑–≤–∏—Ç–∏–µ:</b>

<b>–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞:</b>
‚Ä¢ –ù–∞—á–∞–ª—å–Ω–∞—è —Å—Ç–∞–≤–∫–∞: <b>$3</b> –∑–∞ –∫–∞–∂–¥—ã–µ $150 –æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
‚Ä¢ –ü—Ä–∏–≥–ª–∞—Å–∏—Ç–µ <b>3 –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</b>, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—á–Ω—É—Ç —Ä–∞–±–æ—Ç–∞—Ç—å
‚Ä¢ –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –≤–∞—à–µ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –ø–æ–≤—ã—à–∞–µ—Ç—Å—è –¥–æ <b>$5</b> –∑–∞ –∫–∞–∂–¥—ã–µ $150
‚Ä¢ –≠—Ç–æ –≤–∞—à –ø–µ—Ä–≤—ã–π —à–∞–≥ –∫ —É–≤–µ–ª–∏—á–µ–Ω–∏—é –¥–æ—Ö–æ–¥–∞

<b>–°–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞:</b>
‚Ä¢ –ü–æ—Å–ª–µ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–≤–Ω—è –∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏—è 3 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚Ä¢ –ó–∞ –∫–∞–∂–¥–æ–≥–æ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚Ä¢ –ï—Å–ª–∏ –≤–∞—à–∏ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å—É–º–º–∞—Ä–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç <b>50 –≤—ã–≤–æ–¥–æ–≤</b>
‚Ä¢ –í—ã –ø–æ–ª—É—á–∏—Ç–µ <b>$50</b> –∑–∞ –∫–∞–∂–¥–æ–≥–æ —Ç–∞–∫–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
‚Ä¢ –≠—Ç–æ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç –Ω–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –¥–ª—è –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–≤–µ–ª–∏—á–µ–Ω–∏—è –¥–æ—Ö–æ–¥–∞""",
    
    """‚úÖ <b>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ —Ä–∞–±–æ—Ç—ã —Å –Ω–∞–º–∏:</b>

‚Ä¢ –ë–µ–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –≤–ª–æ–∂–µ–Ω–∏–π
‚Ä¢ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ –≤—ã–ø–ª–∞—Ç
‚Ä¢ –ú–µ–∂–¥—É–Ω–∞—Ä–æ–¥–Ω—ã–π –º–∞—Å—à—Ç–∞–± –ø—Ä–æ–µ–∫—Ç–∞
‚Ä¢ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ 24/7
‚Ä¢ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–æ—Å—Ç–∞ –¥–æ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ —Ä–µ—Ñ–µ—Ä–∞–ª—å–Ω—É—é –ø—Ä–æ–≥—Ä–∞–º–º—É""",
    
    """üì± <b>–ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–±–æ—Ç—ã - —à–∞–≥ –∑–∞ —à–∞–≥–æ–º:</b>

<b>–®–∞–≥ 1 - –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤:</b>
–ù–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å –ø–æ—Å—Ç—É–ø–∞—é—Ç –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ —á–∞—Å—Ç—è–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: 3000 —Å–æ–º, 5000 —Å–æ–º, 4500 —Å–æ–º –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.

<b>–®–∞–≥ 2 - –û—Ç—á–µ—Ç–Ω–æ—Å—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É:</b>
‚Ä¢ –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è —Å—Ä–µ–¥—Å—Ç–≤ –≤—ã <b>–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ</b> –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –±–∞–ª–∞–Ω—Å–∞ –º–µ–Ω–µ–¥–∂–µ—Ä—É
‚Ä¢ –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ–Ω—Ç—Ä–æ–ª—è –∏ —É—á–µ—Ç–∞ –≤—Å–µ—Ö –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–π
‚Ä¢ –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ –∫—É—Ä—Å–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏

<b>–®–∞–≥ 3 - –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –≤—ã–≤–æ–¥:</b>
–ö–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –≤–∏–¥–∏—Ç, —á—Ç–æ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ä–µ–¥—Å—Ç–≤, –æ–Ω –¥–∞–µ—Ç –≤–∞–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤—ã–≤–æ–¥ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–∫–≤–∏–∑–∏—Ç—ã –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞.""",
    
    """üíµ <b>–ü—Ä–∏–º–µ—Ä –ø–µ—Ä–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞:</b>

<b>–°–∏—Ç—É–∞—Ü–∏—è:</b>
–ù–∞–∫–æ–ø–∏–ª–æ—Å—å 23,000 —Å–æ–º. –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–∞–ª –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤—ã–≤–æ–¥.

<b>–†–∞—Å—á–µ—Ç:</b>
1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –¥–æ–ª–ª–∞—Ä—ã:
   23,000 —Å–æ–º √∑ 87 (–∫—É—Ä—Å) = 264$

2. –°—á–∏—Ç–∞–µ–º –≤—ã–≤–æ–¥—ã:
   264$ –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –∫–∞–∫: 150$ + 114$
   
3. –†–µ–∑—É–ª—å—Ç–∞—Ç:
   ‚Ä¢ <b>1 –≤—ã–≤–æ–¥</b> –Ω–∞ —Å—É–º–º—É 150$ ‚Üí –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ <b>3$</b> –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è
   ‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫ 114$ (–º–µ–Ω—å—à–µ 150$) –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

<b>–ò—Ç–æ–≥–æ –ø–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞:</b>
‚úÖ 1 –≤—ã–≤–æ–¥ = 3$ –∑–∞—Ä–∞–±–æ—Ç–∫–∞
üíæ –û—Å—Ç–∞—Ç–æ–∫: 114$""",
    
    """üíµ <b>–ü—Ä–∏–º–µ—Ä –≤—Ç–æ—Ä–æ–≥–æ –≤—ã–≤–æ–¥–∞:</b>

<b>–°–∏—Ç—É–∞—Ü–∏—è:</b>
–°–Ω–æ–≤–∞ –Ω–∞–∫–æ–ø–∏–ª–æ—Å—å 28,000 —Å–æ–º. –ú–µ–Ω–µ–¥–∂–µ—Ä –¥–∞–ª –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤—Ç–æ—Ä–æ–π –≤—ã–≤–æ–¥ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.

<b>–†–∞—Å—á–µ—Ç:</b>
1. –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –Ω–æ–≤—É—é —Å—É–º–º—É:
   28,000 —Å–æ–º √∑ 87 = 321$
   
2. –î–æ–±–∞–≤–ª—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫ —Å –ø—Ä–æ—à–ª–æ–≥–æ —Ä–∞–∑–∞:
   321$ + 114$ (–æ—Å—Ç–∞—Ç–æ–∫) = 435$
   
3. –°—á–∏—Ç–∞–µ–º –ø–µ—Ä–≤—ã–π –≤—ã–≤–æ–¥ –∏–∑ —ç—Ç–æ–π —Å—É–º–º—ã:
   435$ - 150$ = 285$ (–æ—Å—Ç–∞—Ç–æ–∫)
   
4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Å—Ç–∞—Ç–æ–∫:
   285$ –±–æ–ª—å—à–µ 150$, –∑–Ω–∞—á–∏—Ç –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –≤—ã–≤–æ–¥
   285$ - 150$ = 135$ (–Ω–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫)
   
<b>–†–µ–∑—É–ª—å—Ç–∞—Ç:</b>
‚Ä¢ –ò–∑ —ç—Ç–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏: <b>2 –≤—ã–≤–æ–¥–∞</b> –ø–æ 150$ = <b>6$</b> –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏—è
‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫ 135$ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

<b>–û–±—â–∏–π –∏—Ç–æ–≥ –∑–∞ –¥–µ–Ω—å (—Å —É—á–µ—Ç–æ–º –ø–µ—Ä–≤–æ–≥–æ –≤—ã–≤–æ–¥–∞):</b>
‚úÖ 3 –≤—ã–≤–æ–¥–∞ = 9$ –∑–∞—Ä–∞–±–æ—Ç–∫–∞
üíæ –û—Å—Ç–∞—Ç–æ–∫: 135$""",
    
    """üìä <b>–†–∞—Å—á–µ—Ç –∑–∞ –≤–µ—Å—å –¥–µ–Ω—å:</b>

<b>–ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞ –∑–∞ 10.11.2025:</b>

<b>–û–±—â–∞—è —Å—É–º–º–∞ –∑–∞ –¥–µ–Ω—å:</b> 114,055 —Å–æ–º

<b>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –¥–æ–ª–ª–∞—Ä—ã:</b>
114,055 —Å–æ–º √∑ 87 = 1,310.98$

<b>–ü–µ—Ä–≤—ã–π —ç—Ç–∞–ø —Ä–∞—Å—á–µ—Ç–æ–≤:</b>
–ó–∞ —Å–µ–≥–æ–¥–Ω—è <b>5 –≤—ã–≤–æ–¥–æ–≤</b>, –∫–∞–∂–¥—ã–π –ø–æ 150$:
5 √ó 150$ = 750$
–û—Å—Ç–∞—Ç–æ–∫: 1,310.98$ - 750$ = 560.98$

<b>–í—Ç–æ—Ä–æ–π —ç—Ç–∞–ø - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Å—Ç–∞—Ç–∫–∞:</b>
–û—Å—Ç–∞—Ç–æ–∫ 560.98$ –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å:
‚Ä¢ 150$ + 150$ + 150$ + 110.98$ = 560.98$
‚Ä¢ –≠—Ç–æ –¥–∞–µ—Ç –µ—â–µ <b>3 –≤—ã–≤–æ–¥–∞</b> –ø–æ 150$
‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫ 110.98$ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å

<b>–ò—Ç–æ–≥–æ –∑–∞ –¥–µ–Ω—å:</b>
‚úÖ 5 –≤—ã–≤–æ–¥–æ–≤ + 3 –≤—ã–≤–æ–¥–∞ = <b>8 –≤—ã–≤–æ–¥–æ–≤</b>
üí∞ 8 –≤—ã–≤–æ–¥–æ–≤ √ó 3$ = <b>24$</b> (–∏–ª–∏ 2,088 —Å–æ–º)
üíæ –û—Å—Ç–∞—Ç–æ–∫ –Ω–∞ –∑–∞–≤—Ç—Ä–∞: 110.98$

<b>–í–∞–∂–Ω–æ:</b>
–í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –≤—ã–≤–æ–¥–æ–≤ –∏ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É!""",
    
    """üöÄ <b>–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª –∑–∞—Ä–∞–±–æ—Ç–∫–∞:</b>

<b>–ù–∞ –Ω–∞—á–∞–ª—å–Ω–æ–º —É—Ä–æ–≤–Ω–µ:</b>
‚Ä¢ –ó–∞ 8 –≤—ã–≤–æ–¥–æ–≤ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ: 24$ (2,088 —Å–æ–º)
‚Ä¢ –õ–µ–≥–∫–∏–π –∏ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–ø–æ—Å–æ–± –∑–∞—Ä–∞–±–æ—Ç–∫–∞

<b>–ü–æ—Å–ª–µ –∫–∞—Ä—å–µ—Ä–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞:</b>
‚Ä¢ –ü—Ä–∏ –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–∏ 5$ –∑–∞ –∫–∞–∂–¥—ã–π –≤—ã–≤–æ–¥
‚Ä¢ –ó–∞ —Ç–µ –∂–µ 8 –≤—ã–≤–æ–¥–æ–≤: 40$ (3,480 —Å–æ–º)
‚Ä¢ –í–∞—à –¥–æ—Ö–æ–¥ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ 67%!

<b>–í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>
‚Ä¢ –í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–æ–≤
‚Ä¢ –í–∞—à –∑–∞—Ä–∞–±–æ—Ç–æ–∫ —Ä–∞—Å—Ç–µ—Ç —Å –∫–∞–∂–¥—ã–º –≤—ã–≤–æ–¥–æ–º
‚Ä¢ –û—Å—Ç–∞—Ç–∫–∏ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –∏ —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏—è—Ö

–ß–µ–º –∞–∫—Ç–∏–≤–Ω–µ–µ –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ, —Ç–µ–º –±–æ–ª—å—à–µ –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ!""",
    
    """üìÖ <b>–°–∏—Å—Ç–µ–º–∞ –≤—ã–ø–ª–∞—Ç:</b>

<b>–í—ã–ø–ª–∞—Ç—ã –ø—Ä–æ–∏–∑–≤–æ–¥—è—Ç—Å—è –¥–≤–∞ —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é:</b>

<b>–ü–µ—Ä–≤–∞—è –≤—ã–ø–ª–∞—Ç–∞ - –°—É–±–±–æ—Ç–∞:</b>
‚Ä¢ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –¥–µ–Ω—å–≥–∏ –∑–∞ –≤—Ç–æ—Ä–Ω–∏–∫, —Å—Ä–µ–¥—É, —á–µ—Ç–≤–µ—Ä–≥ –∏ –ø—è—Ç–Ω–∏—Ü—É
‚Ä¢ –°—É–º–º–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –≤—ã–≤–æ–¥—ã –∑–∞ —ç—Ç–∏ 4 –¥–Ω—è
‚Ä¢ –ü–æ–ª–Ω—ã–π —Ä–∞—Å—á–µ—Ç –≤–∞—à–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∫–∞

<b>–í—Ç–æ—Ä–∞—è –≤—ã–ø–ª–∞—Ç–∞ - –í—Ç–æ—Ä–Ω–∏–∫:</b>
‚Ä¢ –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –¥–µ–Ω—å–≥–∏ –∑–∞ —Å—É–±–±–æ—Ç—É, –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –∏ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫
‚Ä¢ –°—É–º–º–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –≤—ã–≤–æ–¥—ã –∑–∞ —ç—Ç–∏ 3 –¥–Ω—è
‚Ä¢ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫

<b>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:</b>
‚úÖ –ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—á–µ—Ç–æ–≤
‚úÖ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã
‚úÖ –ë—ã—Å—Ç—Ä–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤
‚úÖ –í—Å–µ –≤—ã–ø–ª–∞—Ç—ã –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É—é—Ç—Å—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏

–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å?"""
]

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∑–∞—è–≤–∫–∏ –∏–∑ —á–∞—Ç–∞
async def cleanup_registration_documents(context: ContextTypes.DEFAULT_TYPE, chat_id=None):
    """–£–¥–∞–ª—è–µ—Ç –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞—è–≤–∫–∏ –∏–∑ —á–∞—Ç–∞
    
    Args:
        context: –ö–æ–Ω—Ç–µ–∫—Å—Ç –±–æ—Ç–∞
        chat_id: ID —á–∞—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –µ—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω, –±—É–¥–µ—Ç –ø–æ–ª—É—á–µ–Ω –∏–∑ update)
    """
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º user_data, –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
    if not hasattr(context, 'user_data') or context.user_data is None:
        context.user_data = {}
        return
    
    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
    previous_doc_messages = context.user_data.get('registration_doc_messages', [])
    if not previous_doc_messages:
        return
    
    # –ï—Å–ª–∏ chat_id –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    # (—ç—Ç–æ fallback, –Ω–æ –ª—É—á—à–µ –ø–µ—Ä–µ–¥–∞–≤–∞—Ç—å chat_id —è–≤–Ω–æ)
    if not chat_id:
        # –ü—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ bot_data (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ)
        return
    
    # –£–¥–∞–ª—è–µ–º –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞—è–≤–∫–∏
    for msg_id in previous_doc_messages:
        try:
            await context.bot.delete_message(chat_id=chat_id, message_id=msg_id)
        except Exception:
            # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ (—Å–æ–æ–±—â–µ–Ω–∏–µ –º–æ–≥–ª–æ –±—ã—Ç—å —É–∂–µ —É–¥–∞–ª–µ–Ω–æ)
            pass
    
    # –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫
    context.user_data['registration_doc_messages'] = []

# –ü–æ–∫–∞–∑ –º–µ–Ω—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
async def show_admin_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü–æ–ª—É—á–∞–µ–º chat_id –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    if update.callback_query:
        chat_id = update.callback_query.message.chat_id
    elif update.effective_chat:
        chat_id = update.effective_chat.id
    else:
        chat_id = update.message.chat_id if update.message else None
    
    # –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞—è–≤–æ–∫ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≤ –º–µ–Ω—é
    if chat_id:
        await cleanup_registration_documents(context, chat_id)
    
    keyboard = [
        [InlineKeyboardButton("üîë –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞", callback_data="admin_generate_code")],
        [InlineKeyboardButton("üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞", callback_data="admin_stats")],
        [InlineKeyboardButton("üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏", callback_data="admin_users")],
        [InlineKeyboardButton("üìÅ –ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é", callback_data="admin_registrations")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    text = "üëë <b>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:"
    
    if update.callback_query:
        await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
    else:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='HTML')

# –ö–æ–º–∞–Ω–¥–∞ /start
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    username = update.effective_user.username
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
    if is_admin(username):
        await show_admin_menu(update, context)
        return
    
    user_state = get_user_state(user_id)
    
    if not user_state:
        save_user_state(user_id, username, 'waiting_code', 0, 0, 0)
        user_state = {'state': 'waiting_code', 'has_access': 0, 'current_page': 0, 'lesson_completed': 0}
    
    if user_state['has_access'] == 0 or user_state['state'] == 'waiting_code':
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –¥–æ–ª–∂–µ–Ω –≤–≤–µ—Å—Ç–∏ –∫–æ–¥
        admin_link = f"https://t.me/{ADMIN_USERNAME}"
        message_text = f"""üîê <b>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</b>

–î–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –±–æ—Ç—É –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–≤–µ—Å—Ç–∏ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞.

–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –º–æ–∂–Ω–æ —É –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞: <a href="{admin_link}">@{ADMIN_USERNAME}</a>

–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞:"""
        
        sent_message = await update.message.reply_text(message_text, parse_mode='HTML')
        save_user_state(user_id, username, 'waiting_code')
        save_bot_message_id(user_id, sent_message.message_id)
    else:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
        await show_main_menu(update, context)

# –ü–æ–∫–∞–∑ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
async def show_main_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ", callback_data="lesson_1")],
        [InlineKeyboardButton("üí∞ –†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞", callback_data="button_2")],
        [InlineKeyboardButton("üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", callback_data="button_3")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    text = "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
    
    if update.callback_query:
        await update.callback_query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
    else:
        await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='HTML')

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–∫–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
async def handle_lesson_1(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    user_state = get_user_state(user_id)
    current_page = user_state['current_page'] if user_state else 0
    
    action = query.data
    
    if action == "lesson_1":
        current_page = 0
        save_user_state(user_id, None, 'lesson_1', 0)
    elif action == "lesson_next":
        current_page = min(current_page + 1, len(LESSON_1_PAGES) - 1)
        save_user_state(user_id, None, 'lesson_1', current_page)
    elif action == "lesson_prev":
        current_page = max(current_page - 1, 0)
        save_user_state(user_id, None, 'lesson_1', current_page)
    elif action == "lesson_main":
        await show_main_menu(update, context)
        return
    elif action == "lesson_continue_yes":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–≥–ª–∞—Å–∏–ª—Å—è –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ 2-—é –∫–Ω–æ–ø–∫—É (—Ä–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞)
        save_user_state(user_id, None, 'calc_intro', 0, 1, 1)
        await handle_button_2(update, context)
        return
    elif action == "lesson_continue_no":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è - —É–¥–∞–ª—è–µ–º –¥–æ—Å—Ç—É–ø
        revoke_user_access(user_id)
        await query.edit_message_text(
            "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∑–∞ –Ω–æ–≤—ã–º –∫–æ–¥–æ–º.",
            parse_mode='HTML'
        )
        return
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
    keyboard = []
    
    # –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ - –æ—Å–æ–±—ã–π –ø–æ—Ä—è–¥–æ–∫ –∫–Ω–æ–ø–æ–∫
    if current_page == len(LESSON_1_PAGES) - 1:
        # –°–Ω–∞—á–∞–ª–∞ –∫–Ω–æ–ø–∫–∏ –î–∞/–ù–µ—Ç
        keyboard.append([
            InlineKeyboardButton("‚úÖ –î–∞, –ø—Ä–æ–¥–æ–ª–∂–∞—é", callback_data="lesson_continue_yes"),
            InlineKeyboardButton("‚ùå –ù–µ—Ç, –æ—Ç–∫–∞–∑—ã–≤–∞—é—Å—å", callback_data="lesson_continue_no")
        ])
        # –ó–∞—Ç–µ–º –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥ –∏ –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –≤ –æ–¥–Ω–æ–º —Ä—è–¥—É
        bottom_buttons = []
        if current_page > 0:
            bottom_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="lesson_prev"))
        bottom_buttons.append(InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="lesson_main"))
        keyboard.append(bottom_buttons)
    else:
        # –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Å—Ç—Ä–∞–Ω–∏—Ü - –æ–±—ã—á–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫
        nav_buttons = []
        if current_page > 0:
            nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="lesson_prev"))
        if current_page < len(LESSON_1_PAGES) - 1:
            nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚ñ∂Ô∏è", callback_data="lesson_next"))
        
        if nav_buttons:
            keyboard.append(nav_buttons)
        
        # –ö–Ω–æ–ø–∫–∞ "–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é"
        keyboard.append([InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="lesson_main")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    page_text = LESSON_1_PAGES[current_page]
    page_info = f"\n\nüìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1} –∏–∑ {len(LESSON_1_PAGES)}"
    
    await query.edit_message_text(
        page_text + page_info,
        reply_markup=reply_markup,
        parse_mode='HTML'
    )

# –¢–µ–∫—Å—Ç—ã –¥–ª—è —Ä–∞–∑–¥–µ–ª–∞ "–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞" (11 —Å—Ç—Ä–∞–Ω–∏—Ü)
CALC_INTRO_PAGES = [
    """üéâ <b>–û—Ç–ª–∏—á–Ω–∞—è –Ω–æ–≤–æ—Å—Ç—å!</b>

–í–∞–º –Ω–µ –Ω—É–∂–Ω–æ –≤—Ä—É—á–Ω—É—é —Å—á–∏—Ç–∞—Ç—å –∫–∞–∂–¥—É—é —Å–≤–æ—é –ø—Ä–∏–±—ã–ª—å!

–ú—ã –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª–∏ –≤–∞–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–≥–æ –±–æ—Ç–∞-–∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –≤—Å–µ –≤–∞—à–∏ –¥–æ—Ö–æ–¥—ã.

<b>–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</b>
‚Ä¢ –í –∫–æ–Ω—Ü–µ –¥–Ω—è –≤—ã —Å—É–º–º–∏—Ä—É–µ—Ç–µ –≤—Å–µ —Å–≤–æ–∏ –≤—ã–≤–æ–¥—ã
‚Ä¢ –ü–æ–ª—É—á–∞–µ—Ç–µ –æ–±—â—É—é —Å—É–º–º—É –≤ —Å–æ–º–∞—Ö
‚Ä¢ –í–≤–æ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ –±–æ—Ç–∞
‚Ä¢ –ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –≤–∞—à –¥–æ—Ö–æ–¥!""",
    
    """üí° <b>–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞:</b>

‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
‚úÖ –£—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–æ–≤ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –¥–Ω–µ–π
‚úÖ –¢–æ—á–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –≤—ã–≤–æ–¥–æ–≤
‚úÖ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
‚úÖ –ì–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è

<b>–≠—Ç–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç –≤–∞–º –≤—Ä–µ–º—è –∏ –∏—Å–∫–ª—é—á–∏—Ç –æ—à–∏–±–∫–∏ –≤ —Ä–∞—Å—á–µ—Ç–∞—Ö!</b>

–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –±—ã—Å—Ç—Ä–æ –∏ —Ç–æ—á–Ω–æ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π –¥–æ—Ö–æ–¥ –∑–∞ –ª—é–±–æ–π –¥–µ–Ω—å.""",
    
    """üìã <b>–ß—Ç–æ –≤–∞–º –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞:</b>

–ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ä–∞—Å—á–µ—Ç–∞ –ø–æ–¥–≥–æ—Ç–æ–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é:

1. <b>–û–±—â–∞—è —Å—É–º–º–∞ –≤—Å–µ—Ö –≤—ã–≤–æ–¥–æ–≤</b> - —Å–ª–æ–∂–∏—Ç–µ –≤—Å–µ —Å—É–º–º—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –≤—ã–≤–æ–¥–∏–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –≤ —Å–æ–º–∞—Ö

2. <b>–î–∞—Ç–∞ —Ä–∞–±–æ—Ç—ã</b> - –¥–µ–Ω—å, –∑–∞ –∫–æ—Ç–æ—Ä—ã–π –≤—ã –¥–µ–ª–∞–µ—Ç–µ —Ä–∞—Å—á–µ—Ç (—Ñ–æ—Ä–º–∞—Ç: –î–î.–ú–ú.–ì–ì–ì–ì)

3. <b>–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞</b> - –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –Ω–∞ –ø–æ–∫—É–ø–∫—É –Ω–∞ –º–æ–º–µ–Ω—Ç —Ä–∞—Å—á–µ—Ç–æ–≤

4. <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–æ–≤</b> - —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤—ã –≤—ã–≤–æ–¥–∏–ª–∏ –¥–µ–Ω—å–≥–∏ –∑–∞ –¥–µ–Ω—å

5. <b>–û—Å—Ç–∞—Ç–æ–∫ —Å –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è</b> (–µ—Å–ª–∏ –µ—Å—Ç—å) - —Å—É–º–º–∞ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö, –æ—Å—Ç–∞–≤—à–∞—è—Å—è —Å –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –¥–Ω—è""",
    
    """üíµ <b>–®–∞–≥ 1: –û–±—â–∞—è —Å—É–º–º–∞ –≤ —Å–æ–º–∞—Ö</b>

–í –∫–æ–Ω—Ü–µ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è —Å–ª–æ–∂–∏—Ç–µ –≤—Å–µ —Å—É–º–º—ã –≤—ã–≤–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–µ–ª–∞–ª–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è.

<b>–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ—Å—á–∏—Ç–∞—Ç—å:</b>
‚Ä¢ –í—Å–ø–æ–º–Ω–∏—Ç–µ –≤—Å–µ –≤—ã–≤–æ–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –¥–µ–ª–∞–ª–∏ –∑–∞ –¥–µ–Ω—å
‚Ä¢ –°–ª–æ–∂–∏—Ç–µ –≤—Å–µ —Å—É–º–º—ã –≤–º–µ—Å—Ç–µ
‚Ä¢ –ü–æ–ª—É—á–∏—Ç–µ –æ–±—â—É—é —Å—É–º–º—É –≤ —Å–æ–º–∞—Ö

<b>–ü—Ä–∏–º–µ—Ä:</b>
‚Ä¢ –ü–µ—Ä–≤—ã–π –≤—ã–≤–æ–¥: 23,000 —Å–æ–º
‚Ä¢ –í—Ç–æ—Ä–æ–π –≤—ã–≤–æ–¥: 28,000 —Å–æ–º
‚Ä¢ –¢—Ä–µ—Ç–∏–π –≤—ã–≤–æ–¥: 15,000 —Å–æ–º
‚Ä¢ –ß–µ—Ç–≤–µ—Ä—Ç—ã–π –≤—ã–≤–æ–¥: 21,560 —Å–æ–º

<b>–û–±—â–∞—è —Å—É–º–º–∞:</b> 87,560 —Å–æ–º

–ë–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –≤–∞—Å –≤–≤–µ—Å—Ç–∏ —ç—Ç—É —Å—É–º–º—É. –í—ã –º–æ–∂–µ—Ç–µ –≤–≤–µ—Å—Ç–∏ –ª—é–±—É—é —Å–≤–æ—é —Å—É–º–º—É.""",
    
    """üìÖ <b>–®–∞–≥ 2: –î–∞—Ç–∞ —Ä–∞–±–æ—Ç—ã</b>

–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É, –∑–∞ –∫–æ—Ç–æ—Ä—É—é –≤—ã –¥–µ–ª–∞–µ—Ç–µ —Ä–∞—Å—á–µ—Ç.

<b>–§–æ—Ä–º–∞—Ç –¥–∞—Ç—ã:</b> –î–î.–ú–ú.–ì–ì–ì–ì

<b>–í–∞–∂–Ω–æ:</b>
‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–æ—á–∫–∏ (.) –¥–ª—è —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è —á–∏—Å–µ–ª
‚Ä¢ –ü–µ—Ä–≤—ã–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã - –¥–µ–Ω—å (01-31)
‚Ä¢ –°–ª–µ–¥—É—é—â–∏–µ –¥–≤–µ —Ü–∏—Ñ—Ä—ã - –º–µ—Å—è—Ü (01-12)
‚Ä¢ –ü–æ—Å–ª–µ–¥–Ω–∏–µ —á–µ—Ç—ã—Ä–µ —Ü–∏—Ñ—Ä—ã - –≥–æ–¥ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 2025)

<b>–ü—Ä–∏–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞:</b>
‚Ä¢ 10.11.2025
‚Ä¢ 15.12.2025
‚Ä¢ 01.01.2026

–ë–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –≤–∞—Å –≤–≤–µ—Å—Ç–∏ –¥–∞—Ç—É –∏–º–µ–Ω–Ω–æ –≤ —ç—Ç–æ–º —Ñ–æ—Ä–º–∞—Ç–µ.""",
    
    """üí≤ <b>–®–∞–≥ 3: –ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞</b>

–í–∞–º –Ω—É–∂–Ω–æ —É–∑–Ω–∞—Ç—å –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –Ω–∞ –º–æ–º–µ–Ω—Ç —Ä–∞—Å—á–µ—Ç–æ–≤.

<b>–í–∞–∂–Ω–æ:</b> –°–º–æ—Ç—Ä–∏—Ç–µ –∫—É—Ä—Å –Ω–∞ <b>–ø–æ–∫—É–ø–∫—É</b>, –∞ –Ω–µ –Ω–∞ –ø—Ä–æ–¥–∞–∂—É!

<b>–ì–¥–µ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∫—É—Ä—Å:</b>
‚Ä¢ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚Ä¢ –û–±–º–µ–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã
‚Ä¢ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–∞–π—Ç—ã
‚Ä¢ –ö—É—Ä—Å—ã –≤–∞–ª—é—Ç –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ
‚Ä¢ –°–ø—Ä–∞–≤–æ—á–Ω—ã–µ —Å–ª—É–∂–±—ã –±–∞–Ω–∫–æ–≤

<b>–ü—Ä–∏–º–µ—Ä:</b> –ï—Å–ª–∏ –∫—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ –∫ —Å–æ–º—É —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 87 —Å–æ–º –∑–∞ 1 –¥–æ–ª–ª–∞—Ä, –≤–≤–µ–¥–∏—Ç–µ: 87

<b>–ü–æ–º–Ω–∏—Ç–µ:</b> –ö—É—Ä—Å –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω—è—Ç—å—Å—è, –ø–æ—ç—Ç–æ–º—É –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π –∫—É—Ä—Å –Ω–∞ –º–æ–º–µ–Ω—Ç —Ä–∞—Å—á–µ—Ç–æ–≤.""",
    
    """üí∞ <b>–®–∞–≥ 4: –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–æ–≤</b>

–ü–æ–¥—Å—á–∏—Ç–∞–π—Ç–µ, —Å–∫–æ–ª—å–∫–æ —Ä–∞–∑ –≤ —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è –≤—ã –≤—ã–≤–æ–¥–∏–ª–∏ –¥–µ–Ω—å–≥–∏.

<b>–ß—Ç–æ —Å—á–∏—Ç–∞–µ—Ç—Å—è –≤—ã–≤–æ–¥–æ–º:</b>
–ö–∞–∂–¥—ã–π —Ä–∞–∑, –∫–æ–≥–¥–∞ –º–µ–Ω–µ–¥–∂–µ—Ä –¥–∞–≤–∞–ª –≤–∞–º –∫–æ–º–∞–Ω–¥—É –Ω–∞ –≤—ã–≤–æ–¥ –∏ –≤—ã –ø–µ—Ä–µ–≤–æ–¥–∏–ª–∏ –¥–µ–Ω—å–≥–∏ –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ä–µ–∫–≤–∏–∑–∏—Ç - —ç—Ç–æ –æ–¥–∏–Ω –≤—ã–≤–æ–¥.

<b>–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å:</b>
‚Ä¢ –í—Å–ø–æ–º–Ω–∏—Ç–µ –≤—Å–µ —Å–ª—É—á–∞–∏, –∫–æ–≥–¥–∞ –≤—ã –ø–µ—Ä–µ–≤–æ–¥–∏–ª–∏ –¥–µ–Ω—å–≥–∏
‚Ä¢ –ü–æ–¥—Å—á–∏—Ç–∞–π—Ç–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∞–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
‚Ä¢ –í–≤–µ–¥–∏—Ç–µ —ç—Ç–æ —á–∏—Å–ª–æ

<b>–ü—Ä–∏–º–µ—Ä:</b>
‚Ä¢ –£—Ç—Ä–æ: 1 –≤—ã–≤–æ–¥
‚Ä¢ –î–µ–Ω—å: 2 –≤—ã–≤–æ–¥–∞
‚Ä¢ –í–µ—á–µ—Ä: 1 –≤—ã–≤–æ–¥

<b>–ò—Ç–æ–≥–æ:</b> 4 –≤—ã–≤–æ–¥–∞ –∑–∞ –¥–µ–Ω—å

–ë–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –≤–∞—Å –≤–≤–µ—Å—Ç–∏ —ç—Ç–æ —á–∏—Å–ª–æ.""",
    
    """üìä <b>–®–∞–≥ 5: –û—Å—Ç–∞—Ç–æ–∫ —Å –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è</b>

–ï—Å–ª–∏ –≤ –∫–æ–Ω—Ü–µ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Ä–∞–±–æ—á–µ–≥–æ –¥–Ω—è —É –≤–∞—Å –æ—Å—Ç–∞–ª—Å—è –æ—Å—Ç–∞—Ç–æ–∫ (—Å—É–º–º–∞ –º–µ–Ω—å—à–µ 150$), –∫–æ—Ç–æ—Ä—ã–π –≤—ã –ø–µ—Ä–µ–Ω–µ—Å–ª–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å, –≤–∞–º –Ω—É–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å—É–º–º—É.

<b>–ö–æ–≥–¥–∞ –æ—Å—Ç–∞—Ç–æ–∫ –µ—Å—Ç—å:</b>
‚Ä¢ –í—ã –≤—á–µ—Ä–∞ –¥–µ–ª–∞–ª–∏ —Ä–∞—Å—á–µ—Ç
‚Ä¢ –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ –æ—Å—Ç–∞–ª–∞—Å—å —Å—É–º–º–∞ –º–µ–Ω—å—à–µ 150$
‚Ä¢ –í—ã —ç—Ç—É —Å—É–º–º—É –æ—Å—Ç–∞–≤–∏–ª–∏ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
‚Ä¢ –≠—Ç—É —Å—É–º–º—É –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫ —Å–µ–≥–æ–¥–Ω—è—à–Ω–∏–º —Ä–∞—Å—á–µ—Ç–∞–º

<b>–ö–æ–≥–¥–∞ –æ—Å—Ç–∞—Ç–∫–∞ –Ω–µ—Ç:</b>
‚Ä¢ –≠—Ç–æ –≤–∞—à –ø–µ—Ä–≤—ã–π –¥–µ–Ω—å —Ä–∞–±–æ—Ç—ã
‚Ä¢ –í—á–µ—Ä–∞ —É –≤–∞—Å –Ω–µ –±—ã–ª–æ –æ—Å—Ç–∞—Ç–∫–∞
‚Ä¢ –í—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤–µ—Å—å –æ—Å—Ç–∞—Ç–æ–∫ –≤—á–µ—Ä–∞
‚Ä¢ –û—Å—Ç–∞—Ç–æ–∫ –±—ã–ª –Ω—É–ª–µ–≤—ã–º

–ë–æ—Ç —Å–ø—Ä–æ—Å–∏—Ç —É –≤–∞—Å: "–ï—Å—Ç—å –ª–∏ –æ—Å—Ç–∞—Ç–æ–∫ —Å –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è?" - –≤—ã –æ—Ç–≤–µ—Ç–∏—Ç–µ "–î–∞" –∏–ª–∏ "–ù–µ—Ç".

–ï—Å–ª–∏ –≤—ã–±–µ—Ä–µ—Ç–µ "–î–∞", –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –≤–≤–µ—Å—Ç–∏ –æ—Å—Ç–∞—Ç–æ–∫ –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö.""",
    
    """üéØ <b>–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç:</b>

–ü–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –≤—ã –≤–≤–µ–¥–µ—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –±–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–∏—Ç —Å–ª–µ–¥—É—é—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã:

1. <b>–ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≤ –¥–æ–ª–ª–∞—Ä—ã</b>
   –ë–æ—Ç –ø–µ—Ä–µ–≤–µ–¥–µ—Ç –æ–±—â—É—é —Å—É–º–º—É –∏–∑ —Å–æ–º –≤ –¥–æ–ª–ª–∞—Ä—ã –ø–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –∫—É—Ä—Å—É

2. <b>–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Å—Ç–∞—Ç–∫–∞</b>
   –ï—Å–ª–∏ –±—ã–ª –æ—Å—Ç–∞—Ç–æ–∫ —Å –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è, –±–æ—Ç –¥–æ–±–∞–≤–∏—Ç –µ–≥–æ –∫ –æ–±—â–µ–π —Å—É–º–º–µ

3. <b>–†–∞—Å—á–µ—Ç –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤</b>
   –ë–æ—Ç –ø–æ—Å—á–∏—Ç–∞–µ—Ç —Å—É–º–º—É –≤—Å–µ—Ö –≤—ã–≤–æ–¥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —É–∫–∞–∑–∞–ª–∏ (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ √ó 150$)

4. <b>–†–∞—Å—á–µ—Ç –æ—Å—Ç–∞—Ç–∫–∞</b>
   –ë–æ—Ç –≤—ã—á—Ç–µ—Ç —Å—É–º–º—É –≤—ã–≤–æ–¥–æ–≤ –∏–∑ –æ–±—â–µ–π —Å—É–º–º—ã –∏ –ø–æ–ª—É—á–∏—Ç –æ—Å—Ç–∞—Ç–æ–∫

5. <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã</b>
   –ï—Å–ª–∏ –æ—Å—Ç–∞—Ç–æ–∫ –±–æ–ª—å—à–µ –∏–ª–∏ —Ä–∞–≤–µ–Ω 150$, –±–æ—Ç –ø–æ—Å—á–∏—Ç–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –µ—â–µ –≤—ã–≤–æ–¥–æ–≤ –º–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å

6. <b>–§–∏–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç</b>
   –ë–æ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–æ–≤ –∏ —Å—É–º–º—É, –∫–æ—Ç–æ—Ä–∞—è –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å""",
    
    """‚úÖ <b>–ß—Ç–æ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ –≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–µ:</b>

–ë–æ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç –≤–∞–º –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å —Ä–∞—Å—á–µ—Ç–æ–º, –∫–æ—Ç–æ—Ä—ã–π –≤–∫–ª—é—á–∞–µ—Ç:

‚Ä¢ <b>–û–±—â—É—é —Å—É–º–º—É –∑–∞ –¥–µ–Ω—å</b> –≤ —Å–æ–º–∞—Ö –∏ –¥–æ–ª–ª–∞—Ä–∞—Ö
‚Ä¢ <b>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤</b>, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã —É–∫–∞–∑–∞–ª–∏
‚Ä¢ <b>–°—É–º–º—É —ç—Ç–∏—Ö –≤—ã–≤–æ–¥–æ–≤</b> –≤ –¥–æ–ª–ª–∞—Ä–∞—Ö
‚Ä¢ <b>–û—Å—Ç–∞—Ç–æ–∫</b> –ø–æ—Å–ª–µ –æ—Å–Ω–æ–≤–Ω—ã—Ö –≤—ã–≤–æ–¥–æ–≤
‚Ä¢ <b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤—ã–≤–æ–¥—ã</b> –∏–∑ –æ—Å—Ç–∞—Ç–∫–∞ (–µ—Å–ª–∏ –æ—Å—Ç–∞—Ç–æ–∫ –±–æ–ª—å—à–µ 150$)
‚Ä¢ <b>–§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫</b> –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –¥–µ–Ω—å
‚Ä¢ <b>–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–æ–≤</b> –∑–∞ –¥–µ–Ω—å

<b>–≠—Ç–æ—Ç —Ç–µ–∫—Å—Ç –≤—ã —Å–º–æ–∂–µ—Ç–µ:</b>
‚Ä¢ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä—É
‚Ä¢ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–ª—è —É—á–µ—Ç–∞
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –æ—Ç—á–µ—Ç–Ω–æ—Å—Ç–∏
‚Ä¢ –ü–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –∑–∞—Ä–∞–±–æ—Ç–∫–∞

–í—Å–µ —Ä–∞—Å—á–µ—Ç—ã –±—É–¥—É—Ç —Ç–æ—á–Ω—ã–º–∏ –∏ –≥–æ—Ç–æ–≤—ã–º–∏ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!""",
    
    """üöÄ <b>–ù–∞—á–∏–Ω–∞–µ–º —Ä–∞—Å—á–µ—Ç!</b>

–¢–µ–ø–µ—Ä—å, –∫–æ–≥–¥–∞ –≤—ã –∑–Ω–∞–µ—Ç–µ, –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏ —á—Ç–æ –Ω—É–∂–Ω–æ –ø–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å, –¥–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω–µ–º!

–ë–æ—Ç –±—É–¥–µ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å —É –≤–∞—Å:
1. –û–±—â—É—é —Å—É–º–º—É –≤ —Å–æ–º–∞—Ö
2. –î–∞—Ç—É —Ä–∞–±–æ—Ç—ã
3. –ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞
4. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤—ã–≤–æ–¥–æ–≤
5. –û—Å—Ç–∞—Ç–æ–∫ —Å –ø—Ä–æ—à–ª–æ–≥–æ –¥–Ω—è (–µ—Å–ª–∏ –µ—Å—Ç—å)

<b>–ü—Ä–æ—Å—Ç–æ –æ—Ç–≤–µ—á–∞–π—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –±–æ—Ç–∞, –∏ –æ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å—Å—á–∏—Ç–∞–µ—Ç –≤–∞—à –¥–æ—Ö–æ–¥!</b>

<b>–í–∞–∂–Ω–æ:</b> –í–≤–æ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –∏ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∏—Ö –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π. –û—Ç —Ç–æ—á–Ω–æ—Å—Ç–∏ –≤–≤–µ–¥–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–∏—Å–∏—Ç —Ç–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å—á–µ—Ç–∞.

–ü–æ—Å–ª–µ —Ç–æ–≥–æ –∫–∞–∫ –≤—ã –≤–≤–µ–¥–µ—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ, –±–æ—Ç –º–≥–Ω–æ–≤–µ–Ω–Ω–æ –ø–æ–∫–∞–∂–µ—Ç –≤–∞–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞—Å—á–µ—Ç–∞."""
]

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–¥–µ–ª–∞ "–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞" —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
async def handle_calc_intro(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if query:
        await query.answer()
        user_id = query.from_user.id
    else:
        user_id = update.effective_user.id
    
    user_state = get_user_state(user_id)
    current_page = user_state['current_page'] if user_state else 0
    
    action = query.data if query else None
    
    if action == "calc_intro_next":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –ª–∏ –º—ã —Å—Ç—Ä–∞–Ω–∏—Ü–µ
        if current_page == len(CALC_INTRO_PAGES) - 1:
            # –ï—Å–ª–∏ –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –∏ –Ω–∞–∂–∞–ª–∏ "–í–ø–µ—Ä–µ–¥" - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –≤–æ–ø—Ä–æ—Å –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
            save_user_state(user_id, None, 'calc_ready_ask')
            text = "üöÄ <b>–ì–æ—Ç–æ–≤—ã —Å—Ç–∞—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–æ–º –ø—Ä–æ–µ–∫—Ç–∞ –∏ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ —Ä–∞–±–æ—Ç–µ?</b>"
            
            keyboard = [
                [
                    InlineKeyboardButton("‚úÖ –î–∞", callback_data="calc_ready_yes"),
                    InlineKeyboardButton("‚ùå –ù–µ—Ç", callback_data="calc_ready_no")
                ],
                [
                    InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="calc_intro_prev"),
                    InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")
                ]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            
            if query:
                await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
            else:
                await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='HTML')
            return
        else:
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            current_page = min(current_page + 1, len(CALC_INTRO_PAGES) - 1)
            save_user_state(user_id, None, 'calc_intro', current_page)
    elif action == "calc_intro_prev":
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏–º—Å—è –ª–∏ –º—ã –Ω–∞ —ç–∫—Ä–∞–Ω–µ "–ì–æ—Ç–æ–≤—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?"
        user_state = get_user_state(user_id)
        if user_state and user_state['state'] == 'calc_ready_ask':
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
            current_page = len(CALC_INTRO_PAGES) - 1
            save_user_state(user_id, None, 'calc_intro')
        else:
            current_page = max(current_page - 1, 0)
        save_user_state(user_id, None, 'calc_intro', current_page)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü
    keyboard = []
    
    nav_buttons = []
    if current_page > 0:
        nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="calc_intro_prev"))
    nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚ñ∂Ô∏è", callback_data="calc_intro_next"))
    
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    keyboard.append([InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    page_text = CALC_INTRO_PAGES[current_page]
    page_info = f"\n\nüìÑ –°—Ç—Ä–∞–Ω–∏—Ü–∞ {current_page + 1} –∏–∑ {len(CALC_INTRO_PAGES)}"
    
    if query:
        await query.edit_message_text(page_text + page_info, reply_markup=reply_markup, parse_mode='HTML')
    else:
        await update.message.reply_text(page_text + page_info, reply_markup=reply_markup, parse_mode='HTML')

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ç–æ—Ä–æ–π –∫–Ω–æ–ø–∫–∏ (–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞)
async def handle_button_2(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    
    user_id = query.from_user.id
    save_user_state(user_id, None, 'calc_intro', 0)
    await handle_calc_intro(update, context)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç—Ä–µ—Ç—å–µ–π –∫–Ω–æ–ø–∫–∏ (–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
async def handle_button_3(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    if query:
        await query.answer()
        user_id = query.from_user.id
    else:
        user_id = update.effective_user.id
    
    username = update.effective_user.username if update.effective_user else query.from_user.username
    
    # –°–æ–∑–¥–∞–µ–º –∏–ª–∏ –ø–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    create_registration_application(user_id, username)
    
    # –≠—Ç–∞–ø 1: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π —ç—Ç–∞–ø
    welcome_text = """üëã <b>–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å!</b>

–ú—ã –ø–æ–ø—Ä–æ—Å–∏–º —Ç–æ–ª—å–∫–æ –º–∏–Ω–∏–º—É–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, —á—Ç–æ–±—ã –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤–∞—à—É –ª–∏—á–Ω–æ—Å—Ç—å. –í—Å—ë –ª–∏—à–Ω–µ–µ –º–æ–∂–Ω–æ –∑–∞–º–∞–∑–∞—Ç—å ‚Äî –º—ã –ø—Ä–∏–Ω–∏–º–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏.

–ï—Å–ª–∏ –≥–æ—Ç–æ–≤—ã ‚Äî –Ω–∞–∂–º–∏—Ç–µ ¬´–ù–∞—á–∞—Ç—å¬ª, –∏ —è –ø—Ä–æ–≤–µ–¥—É –≤–∞—Å –ø–æ –∫–∞–∂–¥–æ–º—É —à–∞–≥—É."""
    
    keyboard = [
        [InlineKeyboardButton("‚úÖ –ù–∞—á–∞—Ç—å", callback_data="reg_start")],
        [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    save_user_state(user_id, username, 'registration_welcome', 0)
    
    if query:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ñ–æ—Ç–æ –≤ —Ç–µ–∫—É—â–µ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
        current_message = query.message
        has_photo = current_message.photo is not None and len(current_message.photo) > 0
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ
        if has_photo:
            try:
                await context.bot.delete_message(chat_id=user_id, message_id=current_message.message_id)
                # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                sent_msg = await context.bot.send_message(
                    chat_id=user_id,
                    text=welcome_text,
                    reply_markup=reply_markup,
                    parse_mode='HTML'
                )
                save_bot_message_id(user_id, sent_msg.message_id)
            except Exception:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å, –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç
                try:
                    edited_msg = await query.edit_message_text(welcome_text, reply_markup=reply_markup, parse_mode='HTML')
                    if hasattr(edited_msg, 'message_id'):
                        save_bot_message_id(user_id, edited_msg.message_id)
                    else:
                        save_bot_message_id(user_id, query.message.message_id)
                except Exception:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                    sent_msg = await context.bot.send_message(
                        chat_id=user_id,
                        text=welcome_text,
                        reply_markup=reply_markup,
                        parse_mode='HTML'
                    )
                    save_bot_message_id(user_id, sent_msg.message_id)
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
            try:
                edited_msg = await query.edit_message_text(welcome_text, reply_markup=reply_markup, parse_mode='HTML')
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                if hasattr(edited_msg, 'message_id'):
                    save_bot_message_id(user_id, edited_msg.message_id)
                else:
                    save_bot_message_id(user_id, query.message.message_id)
            except Exception:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                sent_msg = await context.bot.send_message(
                    chat_id=user_id,
                    text=welcome_text,
                    reply_markup=reply_markup,
                    parse_mode='HTML'
                )
                save_bot_message_id(user_id, sent_msg.message_id)
    else:
        sent_msg = await update.message.reply_text(welcome_text, reply_markup=reply_markup, parse_mode='HTML')
        save_bot_message_id(user_id, sent_msg.message_id)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —ç—Ç–∞–ø–æ–≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
async def handle_registration_stage(update: Update, context: ContextTypes.DEFAULT_TYPE, stage, edit_message_id=None):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —ç—Ç–∞–ø–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ–º —Å–æ–æ–±—â–µ–Ω–∏—è"""
    query = update.callback_query
    user_id = query.from_user.id if query else update.effective_user.id
    username = query.from_user.username if query else update.effective_user.username
    
    # –ü–æ–ª—É—á–∞–µ–º message_id –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if not edit_message_id:
        if query:
            edit_message_id = query.message.message_id
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç query, –ø–æ–ª—É—á–∞–µ–º –∏–∑ —Å–æ—Å—Ç–æ—è–Ω–∏—è
            user_state = get_user_state(user_id)
            edit_message_id = user_state.get('last_bot_message_id') if user_state else None
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if edit_message_id:
        save_bot_message_id(user_id, edit_message_id)
    
    stage_texts = {
        'id_front': """üì∏ <b>–≠—Ç–∞–ø 1/7: –õ–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ID-–∫–∞—Ä—Ç—ã</b>

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –ª–∏—Ü–µ–≤–æ–π —Å—Ç–æ—Ä–æ–Ω—ã ID‚Äë–∫–∞—Ä—Ç—ã. –û—Å—Ç–∞–≤—å—Ç–µ –≤–∏–¥–∏–º—ã–º–∏ —Ç–æ–ª—å–∫–æ –§–ò–û, –¥–∞—Ç—É —Ä–æ–∂–¥–µ–Ω–∏—è –∏ —Ñ–æ—Ç–æ. –û—Å—Ç–∞–ª—å–Ω–æ–µ –º–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å.""",
        
        'id_back': """üì∏ <b>–≠—Ç–∞–ø 2/7 ‚Äî –û–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ID-–∫–∞—Ä—Ç—ã</b>

<b>–ß—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å:</b>
–§–æ—Ç–æ –æ–±—Ä–∞—Ç–Ω–æ–π —Å—Ç–æ—Ä–æ–Ω—ã –≤–∞—à–µ–π ID-–∫–∞—Ä—Ç—ã.

<b>–û—Å—Ç–∞–≤—å—Ç–µ –≤–∏–¥–∏–º—ã–º–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ:</b>
‚Ä¢ –§–∞–º–∏–ª–∏—è, –∏–º—è, –æ—Ç—á–µ—Å—Ç–≤–æ (–§–ò–û)
‚Ä¢ –õ—é–±—ã–µ –¥–∞–Ω–Ω—ã–µ, –∫–æ—Ç–æ—Ä—ã–µ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä—É—é—Ç –≤–∞—Å –∫–∞–∫ –≤–ª–∞–¥–µ–ª—å—Ü–∞ –∫–∞—Ä—Ç—ã (–µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—Ç–º–µ—Ç–∫–∏).

<b>–ß—Ç–æ –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –∏–ª–∏ –∑–∞–º–∞–∑–∞—Ç—å:</b>
‚Ä¢ –ù–æ–º–µ—Ä–∞ –∏ –∫–æ–¥—ã
‚Ä¢ –®—Ç—Ä–∏—Ö-–∫–æ–¥—ã, —Å–ª—É–∂–µ–±–Ω—ã–µ –Ω–∞–¥–ø–∏—Å–∏
‚Ä¢ –õ—é–±—É—é –¥—Ä—É–≥—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã –Ω–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å""",
        
        'address': """üìÑ <b>–≠—Ç–∞–ø 3/7 ‚Äî –î–æ–∫—É–º–µ–Ω—Ç —Å –∞–¥—Ä–µ—Å–æ–º –ø—Ä–æ–ø–∏—Å–∫–∏</b>

–î–ª—è —ç—Ç–æ–≥–æ —à–∞–≥–∞ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å <b>–¥–æ–∫—É–º–µ–Ω—Ç —Å –∞–¥—Ä–µ—Å–æ–º –ø—Ä–æ–ø–∏—Å–∫–∏</b>.

1. –ó–∞–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ <b>Tunduk</b> ‚Üí —Ä–∞–∑–¥–µ–ª <b>¬´–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞¬ª</b>.

2. –°–¥–µ–ª–∞–π—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å –∞–¥—Ä–µ—Å–æ–º –ø—Ä–æ–ø–∏—Å–∫–∏.

–¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å–≤–æ–µ–π –ø—Ä–æ–ø–∏—Å–∫–∏.""",
        
        'passport_photo': """üì∑ <b>–≠—Ç–∞–ø 4/7 ‚Äî –§–æ—Ç–æ —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º –≤ —Ä—É–∫–∞—Ö</b>

–ù–∞ —ç—Ç–æ–º —à–∞–≥–µ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é, –≥–¥–µ –≤—ã –¥–µ—Ä–∂–∏—Ç–µ –ø–∞—Å–ø–æ—Ä—Ç.

<b>–ß—Ç–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤–∏–¥–Ω–æ:</b>
‚Ä¢ –í–∞—à–µ –ª–∏—Ü–æ
‚Ä¢ –°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–∞—Å–ø–æ—Ä—Ç–∞ —Å –§–ò–û –∏ –¥–∞—Ç–æ–π —Ä–æ–∂–¥–µ–Ω–∏—è

<b>–ß—Ç–æ –º–æ–∂–Ω–æ —Å–∫—Ä—ã—Ç—å –∏–ª–∏ –∑–∞–º–∞–∑–∞—Ç—å:</b>
‚Ä¢ –°–µ—Ä–∏–∏ –∏ –Ω–æ–º–µ—Ä–∞ –ø–∞—Å–ø–æ—Ä—Ç–∞""",
        
        'location': """üìç <b>–≠—Ç–∞–ø 5/7: –°–∫—Ä–∏–Ω—à–æ—Ç –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</b>

–û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è.

<b>–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:</b>
‚Ä¢ –°–∫—Ä–∏–Ω—à–æ—Ç —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
‚Ä¢ –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤–∏–¥–Ω–æ –Ω–∞ –∫–∞—Ä—Ç–µ
‚Ä¢ <b>–ß–µ—Ç–∫–æ –≤–∏–¥–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —É–ª–∏—Ü—ã</b>""",
        
        'bank_info': """üí≥ <b>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç–∞—Ö</b>

–ù–∞–ø–∏—à–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–∏—Ö –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç–∞—Ö.

<b>–£–∫–∞–∂–∏—Ç–µ:</b>
‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏—è –±–∞–Ω–∫–æ–≤
‚Ä¢ –ü–ª–∞—Ç–µ–∂–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã (Visa, –≠–ª–∫–∞—Ä—Ç)

<b>–ü—Ä–∏–º–µ—Ä:</b>
–ë–∞–Ω–∫: MBank (Visa)
–ë–∞–Ω–∫: KICB (–≠–ª–∫–∞—Ä—Ç)

–û—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Ç–µ–∫—Å—Ç–æ–º.""",
        
        'legal': """‚öñÔ∏è <b>–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</b>

–ü–µ—Ä–µ–¥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º –æ–∑–Ω–∞–∫–æ–º—å—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏:

‚Ä¢ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º.

‚Ä¢ –í—ã <b>–æ–±—è–∑—É–µ—Ç–µ—Å—å —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Å—Ç–Ω–æ</b> –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –¥–æ—Å—Ç–æ–≤–µ—Ä–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.

‚Ä¢ –ï—Å–ª–∏ –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –≤—ã —Ä–µ—à–∏—Ç–µ –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≤–∞–º –¥–µ–Ω—å–≥–∏ –∏ –ø—Ä–æ–ø–∞—Å—Ç—å, –≤—ã –±—É–¥–µ—Ç–µ <b>–Ω–µ—Å—Ç–∏ –ø–æ–ª–Ω—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∑–∞ —Å–≤–æ–∏ –¥–µ–π—Å—Ç–≤–∏—è</b>. –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –º—ã –ø–µ—Ä–µ–¥–∞–¥–∏–º –¥–∞–Ω–Ω—ã–µ –æ—Ä–≥–∞–Ω–∞–º –≤–ª–∞—Å—Ç–∏ –∏ —Å–º–æ–∂–µ–º –Ω–∞–π—Ç–∏ –≤–∞—Å –ø–æ –ø–∞—Å–ø–æ—Ä—Ç—É –∏–ª–∏ –ø–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π –∫–∞—Ä—Ç–µ.

‚Ä¢ –†–∞–±–æ—Ç–∞–π—Ç–µ —á–µ—Å—Ç–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∏—Å–ø–æ—Ä—Ç–∏—Ç—å —Å–≤–æ—é —Ä–µ–ø—É—Ç–∞—Ü–∏—é.

‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ø–æ—Å–ª–µ –ø—Ä–æ–≤–µ—Ä–∫–∏.

–í—ã –ø—Ä–∏–Ω–∏–º–∞–µ—Ç–µ —É—Å–ª–æ–≤–∏—è, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç–µ —á–µ—Å—Ç–Ω—É—é —Ä–∞–±–æ—Ç—É –∏ —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö?"""
    }
    
    # –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —ç—Ç–∞–ø–æ–≤ –∏ —Ñ–æ—Ç–æ –∏–∑ –ø–∞–ø–∫–∏ images
    stage_images = {
        'id_front': 'images/1.jpg',
        'id_back': 'images/2.jpg',
        'address': 'images/3.jpg',
        'passport_photo': 'images/4.jpg',
        'location': 'images/5.jpg'
    }
    
    stage_states = {
        'id_front': 'registration_id_front',
        'id_back': 'registration_id_back',
        'address': 'registration_address',
        'passport_photo': 'registration_passport_photo',
        'location': 'registration_location',
        'bank_info': 'registration_bank_info',
        'legal': 'registration_legal'
    }
    
    text = stage_texts.get(stage, "")
    state = stage_states.get(stage, 'registration')
    
    save_user_state(user_id, username, state, 0)
    
    if stage == 'legal':
        keyboard = [
            [
                InlineKeyboardButton("‚úÖ –ü—Ä–∏–Ω–∏–º–∞—é —É—Å–ª–æ–≤–∏—è", callback_data="reg_accept"),
                InlineKeyboardButton("‚ùå –û—Ç–∫–∞–∑—ã–≤–∞—é—Å—å", callback_data="reg_decline")
            ],
            [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
        ]
    elif stage == 'bank_info':
        # –î–ª—è —ç—Ç–∞–ø–∞ bank_info —Ç–æ–∂–µ –Ω—É–∂–Ω–∞ –∫–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥"
        keyboard = [
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="reg_back")],
            [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
        ]
    else:
        keyboard = [
            [InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data="reg_back")],
            [InlineKeyboardButton("üè† –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", callback_data="main_menu")]
        ]
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –ü–æ–ª—É—á–∞–µ–º chat_id –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
    if query and query.message:
        chat_id = query.message.chat_id
    else:
        chat_id = user_id  # –î–ª—è –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π chat_id = user_id
    
    # –ï—Å–ª–∏ –µ—Å—Ç—å —Ñ–æ—Ç–æ –¥–ª—è —ç—Ç–æ–≥–æ —ç—Ç–∞–ø–∞ –∏ –µ—Å—Ç—å message_id –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    if stage in stage_images and edit_message_id:
        image_path = stage_images[stage]
        if os.path.exists(image_path):
            try:
                # –†–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, –æ—Ç–ø—Ä–∞–≤–ª—è—è —Ñ–æ—Ç–æ —Å —Ç–µ–∫—Å—Ç–æ–º
                with open(image_path, 'rb') as photo:
                    await context.bot.edit_message_media(
                        chat_id=chat_id,
                        message_id=edit_message_id,
                        media=InputMediaPhoto(media=photo, caption=text, parse_mode='HTML'),
                        reply_markup=reply_markup
                    )
                save_bot_message_id(user_id, edit_message_id)
                return
            except Exception:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –º–µ–¥–∏–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ñ–æ—Ç–æ
                try:
                    with open(image_path, 'rb') as photo:
                        sent_msg = await context.bot.send_photo(
                            chat_id=chat_id,
                            photo=photo,
                            caption=text,
                            reply_markup=reply_markup,
                            parse_mode='HTML'
                        )
                        save_bot_message_id(user_id, sent_msg.message_id)
                    # –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                    try:
                        await context.bot.delete_message(chat_id=chat_id, message_id=edit_message_id)
                    except Exception:
                        pass
                    return
                except Exception:
                    pass
    
    # –ï—Å–ª–∏ –Ω–µ—Ç —Ñ–æ—Ç–æ –∏–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–æ—Ç–æ, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç
    # –ï—Å–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –±—ã–ª–æ —Å —Ñ–æ—Ç–æ, –∞ —Ç–µ–∫—É—â–∏–π —ç—Ç–∞–ø –±–µ–∑ —Ñ–æ—Ç–æ, —É–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä–æ–µ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
    if edit_message_id:
        if query:
            # –ï—Å–ª–∏ –µ—Å—Ç—å query, –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ query
            try:
                await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
                save_bot_message_id(user_id, query.message.message_id)
                return
            except Exception as e:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –±—ã–ª–æ —Ñ–æ—Ç–æ), —É–¥–∞–ª—è–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                try:
                    await context.bot.delete_message(chat_id=chat_id, message_id=edit_message_id)
                except Exception:
                    pass
        else:
            # –ï—Å–ª–∏ –Ω–µ—Ç query, –ø—ã—Ç–∞–µ–º—Å—è –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ bot API
            try:
                await context.bot.edit_message_text(
                    chat_id=chat_id,
                    message_id=edit_message_id,
                    text=text,
                    reply_markup=reply_markup,
                    parse_mode='HTML'
                )
                save_bot_message_id(user_id, edit_message_id)
                return
            except Exception:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–≤–æ–∑–º–æ–∂–Ω–æ, —ç—Ç–æ –±—ã–ª–æ —Ñ–æ—Ç–æ), —É–¥–∞–ª—è–µ–º –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
                try:
                    await context.bot.delete_message(chat_id=chat_id, message_id=edit_message_id)
                except Exception:
                    pass
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —É–¥–∞–ª–æ—Å—å)
        sent_msg = await context.bot.send_message(
            chat_id=chat_id,
            text=text,
            reply_markup=reply_markup,
            parse_mode='HTML'
        )
        save_bot_message_id(user_id, sent_msg.message_id)
    elif query:
        # –ï—Å–ª–∏ –Ω–µ—Ç edit_message_id, –Ω–æ –µ—Å—Ç—å query, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        try:
            await query.edit_message_text(text, reply_markup=reply_markup, parse_mode='HTML')
            save_bot_message_id(user_id, query.message.message_id)
        except Exception:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ
            sent_msg = await context.bot.send_message(
                chat_id=chat_id,
                text=text,
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
            save_bot_message_id(user_id, sent_msg.message_id)
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç –Ω–∏ edit_message_id, –Ω–∏ query, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        if update.message:
            sent_msg = await update.message.reply_text(text, reply_markup=reply_markup, parse_mode='HTML')
        else:
            sent_msg = await context.bot.send_message(
                chat_id=chat_id,
                text=text,
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
        save_bot_message_id(user_id, sent_msg.message_id)


# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.effective_user.id
    username = update.effective_user.username
    user_state = get_user_state(user_id)
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–¥–∞ –¥–æ—Å—Ç—É–ø–∞
    if not user_state or user_state['state'] == 'waiting_code' or user_state['has_access'] == 0:
        if update.message.text:
            text = update.message.text.strip()
            success, message = use_code(text, user_id)
            
            if success:
                save_user_state(user_id, username, 'main_menu', 0, 1, 0)
                last_message_id = user_state.get('last_bot_message_id') if user_state and isinstance(user_state, dict) else None
                if last_message_id:
                    try:
                        keyboard = [
                            [InlineKeyboardButton("üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ", callback_data="lesson_1")],
                            [InlineKeyboardButton("üí∞ –†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞", callback_data="button_2")],
                            [InlineKeyboardButton("üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", callback_data="button_3")]
                        ]
                        reply_markup = InlineKeyboardMarkup(keyboard)
                        text_menu = "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
                        await context.bot.edit_message_text(
                            chat_id=user_id,
                            message_id=last_message_id,
                            text=text_menu,
                            reply_markup=reply_markup,
                            parse_mode='HTML'
                        )
                        try:
                            await update.message.delete()
                        except Exception:
                            pass
                        return
                    except Exception:
                        pass
                await show_main_menu(update, context)
            else:
                await update.message.reply_text(
                    f"‚ùå {message}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –∫–æ–¥ –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.",
                    parse_mode='HTML'
                )
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ - –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
    if user_state['state'] == 'registration_bank_info':
        if update.message.text:
            bank_info = update.message.text.strip()
            update_registration_application(user_id, 'bank_info', bank_info)
            # –ü–æ–ª—É—á–∞–µ–º message_id –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            edit_message_id = user_state.get('last_bot_message_id') if user_state else None
            await handle_registration_stage(update, context, 'legal', edit_message_id)
            try:
                await update.message.delete()
            except Exception:
                pass
        else:
            await update.message.reply_text(
                "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö –∫–∞—Ä—Ç–∞—Ö —Ç–µ–∫—Å—Ç–æ–º.",
                parse_mode='HTML'
            )
        return
    
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥—Ä—É–≥–∏—Ö —Å–æ—Å—Ç–æ—è–Ω–∏–π
    if user_state['state'].startswith('registration_'):
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
            parse_mode='HTML'
        )
        return
    
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø
    await update.message.reply_text(
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏.",
        parse_mode='HTML'
    )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –∏ —Ñ–æ—Ç–æ
async def handle_photo_document(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if not update.message:
        return
    
    user_id = update.effective_user.id
    username = update.effective_user.username
    user_state = get_user_state(user_id)
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
    if not user_state or not user_state['state'].startswith('registration_'):
        return
    
    state = user_state['state']
    file_id = None
    
    # –ü–æ–ª—É—á–∞–µ–º file_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–Ω—Ç–µ–Ω—Ç–∞
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ñ–æ—Ç–æ —Å–Ω–∞—á–∞–ª–∞ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
    if update.message.photo:
        # –ë–µ—Ä–µ–º —Ñ–æ—Ç–æ –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
        file_id = update.message.photo[-1].file_id
    # –ï—Å–ª–∏ —Ñ–æ—Ç–æ –Ω–µ—Ç, –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç
    elif update.message.document:
        file_id = update.message.document.file_id
    elif update.message.location:
        # –î–ª—è –ª–æ–∫–∞—Ü–∏–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ –Ω—É–∂–Ω–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∫—Ä–∏–Ω—à–æ—Ç
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è, –∞ –Ω–µ —Å–∞–º—É –ª–æ–∫–∞—Ü–∏—é.",
            parse_mode='HTML'
        )
        return
    
    if not file_id:
        await update.message.reply_text(
            "‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç.",
            parse_mode='HTML'
        )
        return
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º file_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —ç—Ç–∞–ø–∞
    field_map = {
        'registration_id_front': 'id_front_file_id',
        'registration_id_back': 'id_back_file_id',
        'registration_address': 'address_document_file_id',
        'registration_passport_photo': 'passport_photo_file_id',
        'registration_location': 'location_photo_file_id'
    }
    
    field = field_map.get(state)
    if field:
        update_registration_application(user_id, field, file_id)
        
        # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            await update.message.delete()
        except Exception:
            pass
        
        # –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø
        stage_map = {
            'registration_id_front': 'id_back',
            'registration_id_back': 'address',
            'registration_address': 'passport_photo',
            'registration_passport_photo': 'location',
            'registration_location': 'bank_info'
        }
        
        next_stage = stage_map.get(state)
        if next_stage:
            # –ü–æ–ª—É—á–∞–µ–º message_id –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            edit_message_id = user_state.get('last_bot_message_id') if user_state else None
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π —ç—Ç–∞–ø, —Ä–µ–¥–∞–∫—Ç–∏—Ä—É—è —Å–æ–æ–±—â–µ–Ω–∏–µ
            await handle_registration_stage(update, context, next_stage, edit_message_id)
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π —ç—Ç–∞–ø —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ bank_info
            edit_message_id = user_state.get('last_bot_message_id') if user_state else None
            await handle_registration_stage(update, context, 'bank_info', edit_message_id)
    else:
        await update.message.reply_text(
            "‚ùå –ù–µ–æ–∂–∏–¥–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.",
            parse_mode='HTML'
        )

# –û–±—Ä–∞–±–æ—Ç–∫–∞ callback –∑–∞–ø—Ä–æ—Å–æ–≤
async def handle_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    action = query.data
    user_id = query.from_user.id
    username = query.from_user.username
    
    if action == "main_menu":
        # –ü—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é –∏–∑ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç
        user_state = get_user_state(user_id)
        edit_message_id = None
        if query:
            edit_message_id = query.message.message_id
        if not edit_message_id and user_state:
            edit_message_id = user_state.get('last_bot_message_id')
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
        save_user_state(user_id, username, 'main_menu', 0)
        
        keyboard = [
            [InlineKeyboardButton("üìö –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ", callback_data="lesson_1")],
            [InlineKeyboardButton("üí∞ –†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–∞", callback_data="button_2")],
            [InlineKeyboardButton("üìù –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è", callback_data="button_3")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        text_menu = "üè† <b>–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é</b>\n\n–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:"
        
        # –ï—Å–ª–∏ –µ—Å—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —É–¥–∞–ª—è–µ–º –µ–≥–æ (–æ—Å–æ–±–µ–Ω–Ω–æ –µ—Å–ª–∏ —ç—Ç–æ —Ñ–æ—Ç–æ)
        if edit_message_id:
            try:
                # –ü—ã—Ç–∞–µ–º—Å—è —É–¥–∞–ª–∏—Ç—å —Å—Ç–∞—Ä–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                await context.bot.delete_message(chat_id=user_id, message_id=edit_message_id)
            except Exception:
                # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º - –æ—Ç–ø—Ä–∞–≤–∏–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                pass
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≥–ª–∞–≤–Ω—ã–º –º–µ–Ω—é
        try:
            sent_msg = await context.bot.send_message(
                chat_id=user_id,
                text=text_menu,
                reply_markup=reply_markup,
                parse_mode='HTML'
            )
            save_bot_message_id(user_id, sent_msg.message_id)
        except Exception:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –º–µ—Ç–æ–¥
            await show_main_menu(update, context)
    elif action.startswith("lesson"):
        await handle_lesson_1(update, context)
    elif action.startswith("calc_intro"):
        await handle_calc_intro(update, context)
    elif action == "calc_ready_yes":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≥–æ—Ç–æ–≤ - –ø–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ 3-—é –∫–Ω–æ–ø–∫—É (—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è)
        save_user_state(user_id, None, 'registration')
        await handle_button_3(update, context)
    elif action == "calc_ready_no":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑–∞–ª—Å—è - —É–¥–∞–ª—è–µ–º –¥–æ—Å—Ç—É–ø
        revoke_user_access(user_id)
        await query.edit_message_text(
            "‚ùå –î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∑–∞ –Ω–æ–≤—ã–º –∫–æ–¥–æ–º.",
            parse_mode='HTML'
        )
    elif action == "button_2":
        await handle_button_2(update, context)
    elif action == "button_3":
        await handle_button_3(update, context)
    elif action == "reg_start":
        # –ù–∞—á–∞–ª–æ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ - –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø
        try:
            # –ü–æ–ª—É—á–∞–µ–º message_id –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            user_state = get_user_state(user_id)
            if query and query.message:
                edit_message_id = query.message.message_id
            elif user_state and user_state.get('last_bot_message_id'):
                edit_message_id = user_state.get('last_bot_message_id')
            else:
                edit_message_id = None
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            save_user_state(user_id, username, 'registration_id_front', 0)
            
            # –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            await handle_registration_stage(update, context, 'id_front', edit_message_id)
        except Exception as e:
            # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞—á–∞–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {str(e)}", show_alert=True)
    elif action == "reg_accept":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏–Ω–∏–º–∞–µ—Ç —É—Å–ª–æ–≤–∏—è - –∑–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
        await complete_registration_process(update, context, user_id, username)
    elif action == "reg_decline":
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è - –±–ª–æ–∫–∏—Ä—É–µ–º –∏ —É–¥–∞–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
        delete_user_registration_data(user_id)
        revoke_user_access(user_id)
        await query.edit_message_text(
            "‚ùå –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞. –î–æ—Å—Ç—É–ø –∑–∞–∫—Ä—ã—Ç. –î–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤—Ö–æ–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∑–∞ –Ω–æ–≤—ã–º –∫–æ–¥–æ–º.",
            parse_mode='HTML'
        )
    elif action == "reg_back":
        # –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
        await handle_registration_back(update, context, user_id, username)

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –Ω–∞–∑–∞–¥ –≤ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
async def handle_registration_back(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id, username):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ –ù–∞–∑–∞–¥ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏"""
    query = update.callback_query
    user_state = get_user_state(user_id)
    state = user_state['state'] if user_state else ''
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç—Ç–∞–ø
    back_map = {
        'registration_id_back': 'id_front',
        'registration_address': 'id_back',
        'registration_passport_photo': 'address',
        'registration_location': 'passport_photo',
        'registration_bank_info': 'location',
        'registration_legal': 'bank_info'
    }
    
    prev_stage = back_map.get(state)
    if prev_stage:
        # –ü–æ–ª—É—á–∞–µ–º message_id –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è - –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç —É —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
        edit_message_id = None
        if query:
            edit_message_id = query.message.message_id
        if not edit_message_id and user_state:
            edit_message_id = user_state.get('last_bot_message_id')
        
        # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç—Ç–∞–ø
        stage_states = {
            'id_front': 'registration_id_front',
            'id_back': 'registration_id_back',
            'address': 'registration_address',
            'passport_photo': 'registration_passport_photo',
            'location': 'registration_location',
            'bank_info': 'registration_bank_info',
            'legal': 'registration_legal'
        }
        prev_state = stage_states.get(prev_stage, 'registration')
        save_user_state(user_id, username, prev_state, 0)
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–≥–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if edit_message_id:
            save_bot_message_id(user_id, edit_message_id)
        
        await handle_registration_stage(update, context, prev_stage, edit_message_id)
    else:
        # –ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ–º –≤–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Ñ–æ—Ç–æ (–¥–ª—è —ç—Ç–∞–ø–∞ id_front)
        edit_message_id = None
        if query:
            edit_message_id = query.message.message_id
        
        # –ï—Å–ª–∏ —ç—Ç–æ –ø–µ—Ä–≤—ã–π —ç—Ç–∞–ø —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ (id_front), —É–¥–∞–ª—è–µ–º —Ñ–æ—Ç–æ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
        if state == 'registration_id_front' and edit_message_id:
            # –£–¥–∞–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ñ–æ—Ç–æ
            try:
                await context.bot.delete_message(chat_id=user_id, message_id=edit_message_id)
            except Exception:
                pass
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ (–Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ)
            await handle_button_3(update, context)
        else:
            # –ï—Å–ª–∏ —ç—Ç–æ –Ω–µ —Ñ–æ—Ç–æ-—ç—Ç–∞–ø, –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
            if not edit_message_id and user_state:
                edit_message_id = user_state.get('last_bot_message_id')
            await handle_button_3(update, context)

# –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
async def complete_registration_process(update: Update, context: ContextTypes.DEFAULT_TYPE, user_id, username):
    """–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É"""
    query = update.callback_query
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫—É
    application = get_registration_application(user_id)
    if not application:
        await query.edit_message_text(
            "‚ùå –û—à–∏–±–∫–∞: –∑–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞—á–Ω–∏—Ç–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∑–∞–Ω–æ–≤–æ.",
            parse_mode='HTML'
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
    if not all([application[3], application[4], application[5], application[6], application[7], application[8]]):
        await query.edit_message_text(
            "‚ùå –ù–µ –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≤–µ—Ä—à–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.",
            parse_mode='HTML'
        )
        return
    
    # –ó–∞–≤–µ—Ä—à–∞–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
    complete_registration(user_id)
    save_user_state(user_id, username, 'main_menu', 0)
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    success_text = """‚úÖ <b>–í–∞—à–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã.</b>

–û–Ω–∏ –ø–µ—Ä–µ–¥–∞–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –∏ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ —Å—Ç–∞–¥–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏.

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ–∂–∏–¥–∞–π—Ç–µ ‚Äî –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏."""
    
    keyboard = [
        [InlineKeyboardButton("üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é", callback_data="main_menu")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await query.edit_message_text(success_text, reply_markup=reply_markup, parse_mode='HTML')
    
    # –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –±–∞–∑–µ, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ—Ç –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Ö —á–µ—Ä–µ–∑ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å

# –ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ - –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–æ–¥–∞
async def generate_code(update: Update, context: ContextTypes.DEFAULT_TYPE):
    username = update.effective_user.username
    
    if not is_admin(username):
        await update.message.reply_text("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
        return
    
    code = generate_unique_code()
    admin_link = f"https://t.me/{ADMIN_USERNAME}"
    
    message_text = f"""‚úÖ <b>–ù–æ–≤—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!</b>

üîë <b>–ö–æ–¥:</b> <code>{code}</code>

üìé <b>–°—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</b>
<code>{code}</code>

üë§ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> <a href="{admin_link}">@{ADMIN_USERNAME}</a>

–ö–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."""
    
    keyboard = [
        [InlineKeyboardButton("üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –∫–æ–¥", callback_data="admin_generate_code")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    await update.message.reply_text(message_text, reply_markup=reply_markup, parse_mode='HTML')

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
def get_admin_stats():
    conn = sqlite3.connect('bot_database.db')
    cursor = conn.cursor()
    
    # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫–æ–¥–æ–≤
    cursor.execute('SELECT COUNT(*) FROM access_codes')
    total_codes = cursor.fetchone()[0]
    
    # –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã
    cursor.execute('SELECT COUNT(*) FROM access_codes WHERE is_used = 1')
    used_codes = cursor.fetchone()[0]
    
    # –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –∫–æ–¥—ã
    unused_codes = total_codes - used_codes
    
    # –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    cursor.execute('SELECT COUNT(*) FROM users')
    total_users = cursor.fetchone()[0]
    
    # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç—É–ø–æ–º
    cursor.execute('SELECT COUNT(*) FROM users WHERE has_access = 1')
    active_users = cursor.fetchone()[0]
    
    conn.close()
    
    return {
        'total_codes': total_codes,
        'used_codes': used_codes,
        'unused_codes': unused_codes,
        'total_users': total_users,
        'active_users': active_users
    }

# –û–±—Ä–∞–±–æ—Ç–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É
async def handle_admin_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()
    username = query.from_user.username
    
    if not is_admin(username):
        await query.answer("‚ùå –£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.", show_alert=True)
        return
    
    if query.data == "admin_generate_code":
        code = generate_unique_code()
        admin_link = f"https://t.me/{ADMIN_USERNAME}"
        
        message_text = f"""‚úÖ <b>–ù–æ–≤—ã–π –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!</b>

üîë <b>–ö–æ–¥:</b> <code>{code}</code>

üìé <b>–°—Å—ã–ª–∫–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é:</b>
<code>{code}</code>

üë§ <b>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä:</b> <a href="{admin_link}">@{ADMIN_USERNAME}</a>

–ö–æ–¥ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑."""
        
        keyboard = [
            [InlineKeyboardButton("üîÑ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –µ—â–µ –æ–¥–∏–Ω –∫–æ–¥", callback_data="admin_generate_code")],
            [InlineKeyboardButton("üè† –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="admin_menu")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(message_text, reply_markup=reply_markup, parse_mode='HTML')
    
    elif query.data == "admin_stats":
        stats = get_admin_stats()
        message_text = f"""üìä <b>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–æ—Ç–∞</b>

üîë <b>–ö–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞:</b>
‚Ä¢ –í—Å–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: {stats['total_codes']}
‚Ä¢ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {stats['used_codes']}
‚Ä¢ –ù–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: {stats['unused_codes']}

üë• <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</b>
‚Ä¢ –í—Å–µ–≥–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ: {stats['total_users']}
‚Ä¢ –° –∞–∫—Ç–∏–≤–Ω—ã–º –¥–æ—Å—Ç—É–ø–æ–º: {stats['active_users']}"""
        
        keyboard = [
            [InlineKeyboardButton("üè† –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="admin_menu")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(message_text, reply_markup=reply_markup, parse_mode='HTML')
    
    elif query.data == "admin_users":
        conn = sqlite3.connect('bot_database.db')
        cursor = conn.cursor()
        cursor.execute('''
            SELECT user_id, username, has_access, lesson_completed, last_activity 
            FROM users 
            ORDER BY last_activity DESC 
            LIMIT 10
        ''')
        users = cursor.fetchall()
        conn.close()
        
        if users:
            users_text = "üë• <b>–ü–æ—Å–ª–µ–¥–Ω–∏–µ 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:</b>\n\n"
            for user in users:
                user_id, username, has_access, lesson_completed, last_activity = user
                status = "‚úÖ –ê–∫—Ç–∏–≤–µ–Ω" if has_access else "‚ùå –ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞"
                username_display = f"@{username}" if username else f"ID: {user_id}"
                users_text += f"‚Ä¢ {username_display} - {status}\n"
        else:
            users_text = "üë• <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</b>\n\n–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–∫–∞ –Ω–µ—Ç."
        
        keyboard = [
            [InlineKeyboardButton("üè† –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="admin_menu")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        await query.edit_message_text(users_text, reply_markup=reply_markup, parse_mode='HTML')
    
    elif query.data == "admin_registrations":
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (–∏–Ω–¥–µ–∫—Å 0)
        applications = get_all_registration_applications()
        
        if applications:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É (–∏–Ω–¥–µ–∫—Å 0)
            await view_registration_application_by_index(update, context, 0, show_documents=True)
        else:
            applications_text = "üìÅ <b>–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</b>\n\n–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç."
            keyboard = [
                [InlineKeyboardButton("üè† –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="admin_menu")]
            ]
            reply_markup = InlineKeyboardMarkup(keyboard)
            await query.edit_message_text(applications_text, reply_markup=reply_markup, parse_mode='HTML')
    
    elif query.data.startswith("reg_view_"):
        application_id = int(query.data.split("_")[-1])
        # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –∑–∞—è–≤–∫–∏ –ø–æ ID
        applications = get_all_registration_applications()
        index = None
        for i, app in enumerate(applications):
            if app[0] == application_id:
                index = i
                break
        if index is not None:
            await view_registration_application_by_index(update, context, index, show_documents=True)
        else:
            await query.answer("‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
    
    elif query.data.startswith("reg_nav_"):
        # –§–æ—Ä–º–∞—Ç: reg_nav_{index}
        # –ü—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –º–µ–∂–¥—É –∑–∞—è–≤–∫–∞–º–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∂–¥—É—é –∑–∞—è–≤–∫—É –∫–∞–∫ –µ–¥–∏–Ω–æ–µ –æ–∫–æ—à–∫–æ
        # —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏
        try:
            # –ü–∞—Ä—Å–∏–º –∏–Ω–¥–µ–∫—Å –∏–∑ callback_data (—Ñ–æ—Ä–º–∞—Ç: reg_nav_0, reg_nav_1 –∏ —Ç.–¥.)
            index_str = query.data.replace("reg_nav_", "")
            index = int(index_str)
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞—è–≤–∫—É –ø–æ –∏–Ω–¥–µ–∫—Å—É
            await view_registration_application_by_index(update, context, index, show_documents=True)
        except (ValueError, TypeError) as e:
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∏–Ω–¥–µ–∫—Å–∞: {str(e)}", show_alert=True)
        except Exception as e:
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏: {str(e)}", show_alert=True)
    
    elif query.data.startswith("reg_delete_"):
        # –§–æ—Ä–º–∞—Ç: reg_delete_{index}
        try:
            # –ü–∞—Ä—Å–∏–º –∏–Ω–¥–µ–∫—Å –∏–∑ callback_data (—Ñ–æ—Ä–º–∞—Ç: reg_delete_0, reg_delete_1 –∏ —Ç.–¥.)
            index_str = query.data.replace("reg_delete_", "")
            index = int(index_str)
            
            applications = get_all_registration_applications()
            if 0 <= index < len(applications):
                application_id = applications[index][0]
                await delete_registration_from_admin(update, context, application_id, index)
            else:
                await query.answer("‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
        except (ValueError, TypeError) as e:
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–∞—Ä—Å–∏–Ω–≥–µ –∏–Ω–¥–µ–∫—Å–∞: {str(e)}", show_alert=True)
        except Exception as e:
            await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {str(e)}", show_alert=True)
    
    elif query.data == "admin_menu":
        await show_admin_menu(update, context)

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É
async def view_registration_application_by_index(update: Update, context: ContextTypes.DEFAULT_TYPE, index, show_documents=False):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –ø–æ –∏–Ω–¥–µ–∫—Å—É –≤ —Å–ø–∏—Å–∫–µ"""
    query = update.callback_query
    
    # –ü–æ–ª—É—á–∞–µ–º chat_id
    if query:
        chat_id = query.message.chat_id
    else:
        chat_id = update.effective_chat.id if update.effective_chat else update.message.chat_id
    
    # –£–¥–∞–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞—è–≤–∫–∏ –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –Ω–æ–≤–æ–π
    await cleanup_registration_documents(context, chat_id)
    
    # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –∑–∞—è–≤–∫–∏
    applications = get_all_registration_applications()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å –∏–Ω–¥–µ–∫—Å–∞
    if not applications or index < 0 or index >= len(applications):
        if query:
            await query.answer("‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫—É –ø–æ –∏–Ω–¥–µ–∫—Å—É
    application_id = applications[index][0]
    application = get_registration_application_by_id(application_id)
    
    if not application:
        if query:
            await query.answer("‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
        return
    
    application_id, user_id, username, id_front, id_back, address_doc, passport_photo, location_photo, bank_info, status, created_at = application
    total_count = len(applications)
    current_index = index
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞—è–≤–∫–µ
    info_text = f"""üìÑ <b>–ó–∞—è–≤–∫–∞ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é #{application_id}</b>

üë§ <b>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</b> @{username if username else '–±–µ–∑ username'}
üÜî <b>Telegram ID:</b> <code>{user_id}</code>
üìÖ <b>–î–∞—Ç–∞ –ø–æ–¥–∞—á–∏:</b> {created_at}
üìä <b>–°—Ç–∞—Ç—É—Å:</b> {status}

üí≥ <b>–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</b>
{bank_info if bank_info else '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}

<b>–î–æ–∫—É–º–µ–Ω—Ç—ã:</b>
‚úÖ –õ–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ID: {'–ó–∞–≥—Ä—É–∂–µ–Ω–∞' if id_front else '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞'}
‚úÖ –û–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ID: {'–ó–∞–≥—Ä—É–∂–µ–Ω–∞' if id_back else '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞'}
‚úÖ –î–æ–∫—É–º–µ–Ω—Ç —Å –∞–¥—Ä–µ—Å–æ–º: {'–ó–∞–≥—Ä—É–∂–µ–Ω' if address_doc else '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω'}
‚úÖ –§–æ—Ç–æ —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º: {'–ó–∞–≥—Ä—É–∂–µ–Ω–æ' if passport_photo else '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ'}
‚úÖ –°–∫—Ä–∏–Ω—à–æ—Ç –ª–æ–∫–∞—Ü–∏–∏: {'–ó–∞–≥—Ä—É–∂–µ–Ω' if location_photo else '–ù–µ –∑–∞–≥—Ä—É–∂–µ–Ω'}

üìä <b>–ó–∞—è–≤–∫–∞ {current_index + 1} –∏–∑ {total_count}</b>"""
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
    keyboard = []
    
    # –ö–Ω–æ–ø–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ (–í–ø–µ—Ä–µ–¥/–ù–∞–∑–∞–¥)
    nav_buttons = []
    if current_index > 0:
        # –ö–Ω–æ–ø–∫–∞ "–ù–∞–∑–∞–¥" —Å –∏–Ω–¥–µ–∫—Å–æ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞—è–≤–∫–∏
        nav_buttons.append(InlineKeyboardButton("‚óÄÔ∏è –ù–∞–∑–∞–¥", callback_data=f"reg_nav_{current_index - 1}"))
    
    if current_index < total_count - 1:
        # –ö–Ω–æ–ø–∫–∞ "–í–ø–µ—Ä–µ–¥" —Å –∏–Ω–¥–µ–∫—Å–æ–º —Å–ª–µ–¥—É—é—â–µ–π –∑–∞—è–≤–∫–∏
        nav_buttons.append(InlineKeyboardButton("–í–ø–µ—Ä–µ–¥ ‚ñ∂Ô∏è", callback_data=f"reg_nav_{current_index + 1}"))
    
    if nav_buttons:
        keyboard.append(nav_buttons)
    
    # –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è (—Å –∏–Ω–¥–µ–∫—Å–æ–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è)
    keyboard.append([InlineKeyboardButton("üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å", callback_data=f"reg_delete_{current_index}")])
    
    # –ö–Ω–æ–ø–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –º–µ–Ω—é
    keyboard.append([InlineKeyboardButton("üè† –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="admin_menu")])
    
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞—è–≤–∫–µ
    if query:
        try:
            # –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∑–∞—è–≤–∫–µ
            await query.edit_message_text(info_text, reply_markup=reply_markup, parse_mode='HTML')
        except Exception as e:
            # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Ç–µ–∫—Å—Ç –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è),
            # –ø—Ä–æ–±—É–µ–º –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É
            try:
                await query.edit_message_reply_markup(reply_markup=reply_markup)
            except Exception as e2:
                # –ï—Å–ª–∏ –∏ —ç—Ç–æ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                try:
                    await context.bot.send_message(
                        chat_id=chat_id, 
                        text=info_text, 
                        reply_markup=reply_markup, 
                        parse_mode='HTML'
                    )
                except Exception as e3:
                    # –ï—Å–ª–∏ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–µ —É–¥–∞–ª–∞—Å—å, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –æ–± –æ—à–∏–±–∫–µ
                    await query.answer(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏: {str(e3)}", show_alert=True)
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç query, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –ø–æ–∫–∞–∑–∞)
        await context.bot.send_message(chat_id=chat_id, text=info_text, reply_markup=reply_markup, parse_mode='HTML')
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É (–ø–æ–ª–Ω–æ–µ –æ–∫–æ—à–∫–æ –∑–∞—è–≤–∫–∏)
    # –î–æ–∫—É–º–µ–Ω—Ç—ã –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ show_documents=True
    if show_documents:
        # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è message_id –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
        doc_message_ids = []
        
        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ (–ø—Ä–æ–±—É–µ—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞)
        async def send_file_safe(file_id, caption):
            """–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–∞–π–ª–∞ - –ø—Ä–æ–±—É–µ—Ç –∫–∞–∫ —Ñ–æ—Ç–æ, –ø–æ—Ç–æ–º –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç"""
            message_id = None
            # –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∫–∞–∫ —Ñ–æ—Ç–æ
            try:
                sent_message = await context.bot.send_photo(chat_id=chat_id, photo=file_id, caption=caption)
                message_id = sent_message.message_id
                return message_id
            except Exception:
                pass
            
            # –ï—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å –∫–∞–∫ —Ñ–æ—Ç–æ, –ø—Ä–æ–±—É–µ–º –∫–∞–∫ –¥–æ–∫—É–º–µ–Ω—Ç
            try:
                sent_message = await context.bot.send_document(chat_id=chat_id, document=file_id, caption=caption)
                message_id = sent_message.message_id
                return message_id
            except Exception as e:
                # –ï—Å–ª–∏ –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                try:
                    sent_message = await context.bot.send_message(
                        chat_id=chat_id, 
                        text=f"‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª: {caption}\n–û—à–∏–±–∫–∞: {str(e)}"
                    )
                    message_id = sent_message.message_id
                except Exception:
                    pass
                return message_id
        
        try:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤—Å–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –∑–∞—è–≤–∫–∏ –∫–∞–∫ –µ–¥–∏–Ω–æ–µ –æ–∫–æ—à–∫–æ
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –∫–∞–∂–¥–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞
            if id_front:
                msg_id = await send_file_safe(id_front, f"üì∏ –õ–∏—Ü–µ–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ID-–∫–∞—Ä—Ç—ã\n–ó–∞—è–≤–∫–∞ #{application_id} | {current_index + 1}/{total_count}")
                if msg_id:
                    doc_message_ids.append(msg_id)
            
            if id_back:
                msg_id = await send_file_safe(id_back, f"üì∏ –û–±—Ä–∞—Ç–Ω–∞—è —Å—Ç–æ—Ä–æ–Ω–∞ ID-–∫–∞—Ä—Ç—ã\n–ó–∞—è–≤–∫–∞ #{application_id} | {current_index + 1}/{total_count}")
                if msg_id:
                    doc_message_ids.append(msg_id)
            
            if address_doc:
                msg_id = await send_file_safe(address_doc, f"üìÑ –î–æ–∫—É–º–µ–Ω—Ç —Å –∞–¥—Ä–µ—Å–æ–º –ø—Ä–æ–ø–∏—Å–∫–∏\n–ó–∞—è–≤–∫–∞ #{application_id} | {current_index + 1}/{total_count}")
                if msg_id:
                    doc_message_ids.append(msg_id)
            
            if passport_photo:
                msg_id = await send_file_safe(passport_photo, f"üì∑ –§–æ—Ç–æ —Å –ø–∞—Å–ø–æ—Ä—Ç–æ–º –≤ —Ä—É–∫–∞—Ö\n–ó–∞—è–≤–∫–∞ #{application_id} | {current_index + 1}/{total_count}")
                if msg_id:
                    doc_message_ids.append(msg_id)
            
            if location_photo:
                msg_id = await send_file_safe(location_photo, f"üìç –°–∫—Ä–∏–Ω—à–æ—Ç –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è\n–ó–∞—è–≤–∫–∞ #{application_id} | {current_index + 1}/{total_count}")
                if msg_id:
                    doc_message_ids.append(msg_id)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º message_id –≤—Å–µ—Ö –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
            # –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –¥—Ä—É–≥—É—é –∑–∞—è–≤–∫—É
            context.user_data['registration_doc_messages'] = doc_message_ids
            
        except Exception as e:
            await context.bot.send_message(chat_id=chat_id, text=f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤: {str(e)}")

# –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º (—Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
async def view_registration_application(update: Update, context: ContextTypes.DEFAULT_TYPE, application_id, show_documents=False):
    """–ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –ø–æ ID (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)"""
    # –ù–∞—Ö–æ–¥–∏–º –∏–Ω–¥–µ–∫—Å –∑–∞—è–≤–∫–∏ –ø–æ ID
    applications = get_all_registration_applications()
    index = None
    for i, app in enumerate(applications):
        if app[0] == application_id:
            index = i
            break
    
    if index is not None:
        await view_registration_application_by_index(update, context, index, show_documents)
    else:
        query = update.callback_query
        if query:
            await query.answer("‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)

# –£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
async def delete_registration_from_admin(update: Update, context: ContextTypes.DEFAULT_TYPE, application_id, current_index=None):
    """–£–¥–∞–ª–µ–Ω–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º"""
    query = update.callback_query
    
    # –ü–æ–ª—É—á–∞–µ–º –∑–∞—è–≤–∫—É –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è user_id
    application = get_registration_application_by_id(application_id)
    if not application:
        await query.answer("‚ùå –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.", show_alert=True)
        return
    
    # –£–¥–∞–ª—è–µ–º –∑–∞—è–≤–∫—É
    delete_registration_application(application_id)
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    await query.answer("üóëÔ∏è –ó–∞–ø–∏—Å—å —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞.", show_alert=True)
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
    applications = get_all_registration_applications()
    
    if applications:
        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫—É—é –∑–∞—è–≤–∫—É –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è
        if current_index is not None:
            # –ï—Å–ª–∏ –±—ã–ª —É–∫–∞–∑–∞–Ω –∏–Ω–¥–µ–∫—Å, –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–∫–∞–∑–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ç–æ–º –∂–µ –∏–Ω–¥–µ–∫—Å–µ
            # (–∏–ª–∏ –ø—Ä–µ–¥—ã–¥—É—â—É—é, –µ—Å–ª–∏ —É–¥–∞–ª–∏–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—é—é)
            new_index = min(current_index, len(applications) - 1)
            if new_index >= 0:
                await view_registration_application_by_index(update, context, new_index, show_documents=True)
            else:
                # –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å —Å—Ç–∞–ª –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É
                await view_registration_application_by_index(update, context, 0, show_documents=True)
        else:
            # –ï—Å–ª–∏ –∏–Ω–¥–µ–∫—Å –Ω–µ —É–∫–∞–∑–∞–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–µ—Ä–≤—É—é –∑–∞—è–≤–∫—É
            await view_registration_application_by_index(update, context, 0, show_documents=True)
    else:
        # –ï—Å–ª–∏ –∑–∞—è–≤–æ–∫ –±–æ–ª—å—à–µ –Ω–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        applications_text = "üìÅ <b>–ó–∞—è–≤–∫–∏ –Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é</b>\n\n–ó–∞—è–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç."
        keyboard = [
            [InlineKeyboardButton("üè† –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", callback_data="admin_menu")]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        await query.edit_message_text(applications_text, reply_markup=reply_markup, parse_mode='HTML')

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
def main():
    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
    init_db()
    
    # –°–æ–∑–¥–∞–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    application = Application.builder().token(BOT_TOKEN).build()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("generate_code", generate_code))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Ñ–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ñ–æ—Ç–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    application.add_handler(MessageHandler(filters.PHOTO, handle_photo_document))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    # –í python-telegram-bot 20.7 –∏—Å–ø–æ–ª—å–∑—É–µ–º filters.Document.ALL –¥–ª—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
    application.add_handler(MessageHandler(filters.Document.ALL, handle_photo_document))
    
    # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ –∏ –∞–¥–º–∏–Ω—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –∑–∞—è–≤–∫–∞–º–∏
    # –ü–∞—Ç—Ç–µ—Ä–Ω: admin_* –∏ –∞–¥–º–∏–Ω—Å–∫–∏–µ reg_* (reg_nav_, reg_delete_, reg_view_)
    # –ù–ï –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ reg_* (reg_start, reg_accept, reg_decline, reg_back)
    application.add_handler(CallbackQueryHandler(handle_admin_callback, pattern="^(admin_|reg_nav_|reg_delete_|reg_view_)"))
    # –û–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ callback (–æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ, –≤–∫–ª—é—á–∞—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ reg_*)
    application.add_handler(CallbackQueryHandler(handle_callback))
    
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    logger.info("–ë–æ—Ç –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")
    try:
        application.run_polling(allowed_updates=Update.ALL_TYPES, drop_pending_updates=True)
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞: {e}")
        raise

if __name__ == '__main__':
    main()

